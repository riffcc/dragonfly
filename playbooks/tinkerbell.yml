---
# Tinkerbell Installation Playbook
# Deploys Tinkerbell stack to Kubernetes

- name: Deploy Tinkerbell
  groups:
    - all
  tasks:
    # =================================================================
    # SUDO CHECK
    # =================================================================
    - !shell
      name: Check for passwordless sudo
      cmd: sudo -n true
      save: sudo_check
      and:
        ignore_errors: true

    - !shell
      name: Prompt for sudo password if needed
      cmd: sudo echo -n ""
      with:
        condition: (ne sudo_check.rc 0)

    # =================================================================
    # CHECK PREREQUISITES
    # =================================================================
    - !shell
      name: Check if k3s is running
      cmd: systemctl is-active k3s
      save: k3s_active
      with:
        sudo: root

    - !shell
      name: Check if Helm is installed
      cmd: command -v helm
      save: helm_exists

    # =================================================================
    # CHECK IF TINKERBELL IS ALREADY DEPLOYED
    # =================================================================
    - !shell
      name: Check if tink-system namespace exists
      cmd: /usr/local/bin/k3s kubectl get namespace tink-system
      save: tink_namespace_exists
      with:
        sudo: root
      and:
        ignore_errors: true

    # =================================================================
    # CREATE NAMESPACE
    # =================================================================
    - !shell
      name: Create tink-system namespace
      cmd: /usr/local/bin/k3s kubectl create namespace tink-system
      with:
        sudo: root
        condition: (ne tink_namespace_exists.rc 0)

    # =================================================================
    # GET K3S POD CIDR FOR TRUSTED PROXIES
    # =================================================================
    - !shell
      name: Get k3s pod CIDR
      cmd: /usr/local/bin/k3s kubectl get nodes -o jsonpath='{.items[*].spec.podCIDR}'
      save: pod_cidr
      with:
        sudo: root

    # Note: HookOS artifacts are served by Tinkerbell's built-in nginx (hookos.enabled=true by default)
    # The Helm chart downloads artifacts from GitHub and serves them automatically

    # =================================================================
    # CHECK IF TINKERBELL IS ALREADY INSTALLED
    # =================================================================
    - !shell
      name: Check if Tinkerbell stack is already deployed
      cmd: /usr/local/bin/k3s kubectl get deployment -n tink-system tink-controller
      save: tink_deployed
      with:
        sudo: root
      and:
        ignore_errors: true

    # =================================================================
    # INSTALL TINKERBELL STACK
    # =================================================================
    - !shell
      name: Install Tinkerbell stack using Helm
      cmd: |
        POD_CIDR="{{ pod_cidr.stdout }}"
        helm install tinkerbell oci://ghcr.io/tinkerbell/charts/stack \
          --version 0.6.2 \
          --namespace tink-system \
          --create-namespace \
          --set "smee.trustedProxies={${POD_CIDR}}" \
          --set "publicIP={{ bootstrap_ip }}" \
          --set "hookos.enabled=true" \
          --set "hookos.downloadURL=https://github.com/tinkerbell/hook/releases/download/v0.11.1" \
          --kubeconfig /etc/rancher/k3s/k3s.yaml \
          --wait
      with:
        sudo: root
        condition: (ne tink_deployed.rc 0)

    # =================================================================
    # WAIT FOR TINKERBELL TO BE READY
    # =================================================================
    - !shell
      name: Wait for Tinkerbell controller to be ready
      cmd: |
        for i in {1..60}; do
          if /usr/local/bin/k3s kubectl -n tink-system get deployment tink-controller \
             -o jsonpath='{.status.conditions[?(@.type=="Available")].status}' | grep -q "True"; then
            echo "Tinkerbell controller is ready"
            exit 0
          fi
          echo "Waiting for Tinkerbell controller... ($i/60)"
          sleep 5
        done
        echo "Timeout waiting for Tinkerbell controller"
        exit 1
      with:
        sudo: root
        condition: (ne tink_deployed.rc 0)

    - !echo
      msg: "âœ… Tinkerbell deployed to tink-system namespace"
