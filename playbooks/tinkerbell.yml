---
# Tinkerbell Installation Playbook
# Deploys Tinkerbell stack to Kubernetes

- name: Deploy Tinkerbell
  groups:
    - all
  tasks:
    # =================================================================
    # SUDO CHECK
    # =================================================================
    - !shell
      name: Check for passwordless sudo
      cmd: sudo -n true
      save: sudo_check
      and:
        ignore_errors: true

    - !shell
      name: Prompt for sudo password if needed
      cmd: sudo echo -n ""
      with:
        condition: (ne sudo_check.rc 0)

    # =================================================================
    # CHECK PREREQUISITES
    # =================================================================
    - !shell
      name: Check if k3s is running
      cmd: systemctl is-active k3s
      save: k3s_active
      with:
        sudo: root

    - !shell
      name: Check if Helm is installed
      cmd: command -v helm
      save: helm_exists

    # =================================================================
    # CHECK IF TINKERBELL IS ALREADY DEPLOYED
    # =================================================================
    - !shell
      name: Check if tinkerbell namespace exists
      cmd: /usr/local/bin/k3s kubectl get namespace tinkerbell
      save: tink_namespace_exists
      with:
        sudo: root
      and:
        ignore_errors: true

    # =================================================================
    # CREATE NAMESPACE
    # =================================================================
    - !shell
      name: Create tinkerbell namespace
      cmd: /usr/local/bin/k3s kubectl create namespace tinkerbell
      with:
        sudo: root
        condition: (ne tink_namespace_exists.rc 0)

    # =================================================================
    # GET K3S POD CIDR FOR TRUSTED PROXIES
    # =================================================================
    - !shell
      name: Get k3s pod CIDR
      cmd: /usr/local/bin/k3s kubectl get nodes -o jsonpath='{.items[*].spec.podCIDR}'
      save: pod_cidr
      with:
        sudo: root

    # Note: HookOS artifacts are served via the hookos pod's nginx server on port 7173
    # The Tinkerbell chart automatically deploys hookos when artifactsFileServer is set

    # =================================================================
    # CHECK IF TINKERBELL IS ALREADY INSTALLED
    # =================================================================
    - !shell
      name: Check if Tinkerbell stack is already deployed
      cmd: /usr/local/bin/k3s kubectl get deployment -n tinkerbell tinkerbell
      save: tink_deployed
      with:
        sudo: root
      and:
        ignore_errors: true

    # =================================================================
    # INSTALL TINKERBELL STACK
    # =================================================================
    - !shell
      name: Install Tinkerbell stack using Helm
      cmd: |
        POD_CIDR="{{ pod_cidr.stdout }}"
        helm install tinkerbell oci://ghcr.io/tinkerbell/charts/tinkerbell \
          --version v0.21.1-93b37ac0 \
          --namespace tinkerbell \
          --create-namespace \
          --set "trustedProxies={${POD_CIDR}}" \
          --set "publicIP={{ bootstrap_ip }}" \
          --set "artifactsFileServer=http://{{ bootstrap_ip }}:7173" \
          --kubeconfig /etc/rancher/k3s/k3s.yaml \
          --wait
      with:
        sudo: root
        condition: (ne tink_deployed.rc 0)

    # =================================================================
    # WAIT FOR TINKERBELL TO BE READY
    # =================================================================
    - !shell
      name: Wait for Tinkerbell deployment to be ready
      cmd: |
        for i in {1..60}; do
          if /usr/local/bin/k3s kubectl -n tinkerbell get deployment tinkerbell \
             -o jsonpath='{.status.conditions[?(@.type=="Available")].status}' | grep -q "True"; then
            echo "Tinkerbell is ready"
            exit 0
          fi
          echo "Waiting for Tinkerbell... ($i/60)"
          sleep 5
        done
        echo "Timeout waiting for Tinkerbell"
        exit 1
      with:
        sudo: root
        condition: (ne tink_deployed.rc 0)

    - !echo
      msg: "âœ… Tinkerbell deployed to tinkerbell namespace"
