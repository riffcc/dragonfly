---
# Dragonfly Installation Playbook - K3s/K3d Setup
# This playbook installs k3s (Linux) or k3d (macOS) for Dragonfly
#
# Usage:
#   dragonfly install
#   - or -
#   jetpack local playbooks/install.yml

- name: Install Dragonfly - K3s Setup
  groups:
    - all
  tasks:
    # =================================================================
    # PHASE 1: SUDO CHECK
    # =================================================================
    - !shell
      name: Check for passwordless sudo
      cmd: sudo -n true
      save: sudo_check
      and:
        ignore_errors: true

    - !shell
      name: Prompt for sudo password if needed
      cmd: sudo echo -n ""
      with:
        condition: (ne sudo_check.rc 0)

    # =================================================================
    # PHASE 2: NETWORK DETECTION
    # =================================================================
    - !shell
      name: Detect host IP address
      cmd: |
        ip -4 addr show | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | grep -v '127.0.0.1' | head -1
      save: host_ip

    - !shell
      name: Detect host network CIDR
      cmd: |
        ip -4 addr show | grep -oP '(?<=inet\s)[\d.]+/\d+' | grep -v '127.0.0.1' | head -1
      save: host_cidr

    - !echo
      msg: "Detected host IP: {{ host_ip.stdout }}, Network: {{ host_cidr.stdout }}"

    # =================================================================
    # PHASE 3: INSTALL K3S (Linux) or K3D (macOS)
    # =================================================================
    - !shell
      name: Check if k3s is already installed
      cmd: test -f /etc/rancher/k3s/k3s.yaml && systemctl is-active k3s
      save: k3s_installed
      and:
        ignore_errors: true

    - !shell
      name: Install k3s
      cmd: curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC='--disable traefik' sh -
      with:
        sudo: root
        condition: (ne k3s_installed.rc 0)

    - !shell
      name: Wait for k3s config file
      cmd: |
        for i in {1..12}; do
          if [ -f /etc/rancher/k3s/k3s.yaml ]; then
            exit 0
          fi
          sleep 5
        done
        exit 1
      with:
        condition: (ne k3s_installed.rc 0)

    # =================================================================
    # PHASE 4: CONFIGURE KUBECTL
    # =================================================================
    - !shell
      name: Check if k3s config exists in current directory
      cmd: test -f ./k3s.yaml
      save: kubeconfig_exists
      and:
        ignore_errors: true

    - !shell
      name: Copy k3s config to current directory
      cmd: |
        sudo cp /etc/rancher/k3s/k3s.yaml ./k3s.yaml
        sudo chown $(whoami) ./k3s.yaml
      with:
        condition: (ne kubeconfig_exists.rc 0)

    - !shell
      name: Set KUBECONFIG path
      cmd: echo "$(pwd)/k3s.yaml"
      save: kubeconfig_path

    # =================================================================
    # PHASE 5: INSTALL HELM
    # =================================================================
    - !shell
      name: Check if Helm is already installed
      cmd: command -v helm && helm version
      save: helm_installed
      and:
        ignore_errors: true

    - !shell
      name: Download Helm installer
      cmd: curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 -o /tmp/get_helm.sh
      with:
        condition: (ne helm_installed.rc 0)

    - !shell
      name: Install Helm
      cmd: bash /tmp/get_helm.sh
      with:
        sudo: root
        condition: (ne helm_installed.rc 0)

    - !shell
      name: Verify Helm installation
      cmd: helm version --short
      save: helm_version

    - !echo
      msg: "Helm version: {{ helm_version.stdout }}"

    # =================================================================
    # PHASE 6: WAIT FOR K3S READY
    # =================================================================
    - !shell
      name: Wait for Kubernetes node to be ready
      cmd: |
        for i in {1..60}; do
          if kubectl --kubeconfig={{ kubeconfig_path.stdout }} get nodes --no-headers | grep -q " Ready"; then
            echo "Node is ready"
            exit 0
          fi
          echo "Waiting for node... ($i/60)"
          sleep 5
        done
        echo "Timeout waiting for node"
        exit 1

    - !shell
      name: Wait for CoreDNS to be ready
      cmd: |
        for i in {1..60}; do
          if kubectl --kubeconfig={{ kubeconfig_path.stdout }} get pods -n kube-system -l k8s-app=kube-dns \
             -o jsonpath='{.items[*].status.conditions[?(@.type=="Ready")].status}' | grep -q "True"; then
            echo "CoreDNS is ready"
            exit 0
          fi
          echo "Waiting for CoreDNS... ($i/60)"
          sleep 5
        done
        echo "Timeout waiting for CoreDNS"
        exit 1

    # =================================================================
    # DONE
    # =================================================================
    - !echo
      msg: |
        âœ… K3s and Helm installation completed successfully!

        KUBECONFIG: {{ kubeconfig_path.stdout }}
        Helm: {{ helm_version.stdout }}
