apiVersion: dragonfly.computer/v1
kind: Template
metadata:
  name: debian-13
spec:
  timeout: 9800
  actions:
    - action: image2disk
      url: "https://cloud.debian.org/images/cloud/trixie/daily/latest/debian-13-generic-amd64-daily.tar.xz"
      disk: auto
      timeout: 9600

    - action: writefile
      path: /etc/cloud/ds-identify.cfg
      partition: 1
      content: |
        datasource: NoCloud
      mode: "0644"
      timeout: 90

    - action: writefile
      path: /var/lib/cloud/seed/nocloud/meta-data
      partition: 1
      content: |
        instance-id: {{ instance_id }}
        local-hostname: {{ friendly_name }}
      mode: "0644"
      timeout: 90

    - action: writefile
      path: /var/lib/cloud/seed/nocloud/user-data
      partition: 1
      content: |
        #cloud-config
        manage_etc_hosts: localhost
        users:
          - default
        disable_root: true
        password: DANGERCHANGEME
        chpasswd:
          expire: false
        ssh_pwauth: true
        ssh_import_id:
          - gh:zorlin
          - gh:michatinkers
        packages:
          - qemu-guest-agent
        runcmd:
          - systemctl enable qemu-guest-agent
          - systemctl start qemu-guest-agent
      mode: "0644"
      timeout: 90

    - action: writefile
      path: /etc/network/interfaces.d/eth0
      partition: 1
      content: |
        auto eth0
        iface eth0 inet dhcp
      mode: "0644"
      timeout: 90

    - action: kexec
      partition: 1
      cmdline: "ro quiet"
      timeout: 90
