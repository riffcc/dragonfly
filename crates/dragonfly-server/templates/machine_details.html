{% extends "base.html" %}

{% block head %}
<!-- Lucide icons -->
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
{% endblock %}

{% block content %}

<div x-data="machineDetailsData()"
    x-init="initializeComponent()">

    {# Embed JSON data using script tags #}
    <script id="machine-data-json" type="application/json">
        {{ machine_json | safe }} {# Use safe within script tag #}
    </script>
    <script id="workflow-data-json" type="application/json">
        {{ workflow_info_json | safe }} {# Use safe within script tag #}
    </script>

    {# ===== LAYOUT: SIDEBAR + CONTENT ===== #}
    <div class="flex gap-6 max-w-[1400px] mx-auto">

    {# Sidebar nav #}
    <aside class="hidden lg:flex flex-col gap-1 w-[200px] shrink-0 pt-2">
        <a href="#" class="flex items-center gap-3 px-4 py-3 rounded-lg text-sm bg-purple-600 text-white font-medium">
            <span class="w-5 text-center">üìã</span> Overview
        </a>
        <span class="flex items-center gap-3 px-4 py-3 rounded-lg text-sm text-gray-400 dark:text-gray-600 cursor-default opacity-50">
            <span class="w-5 text-center">üìä</span> Metrics
        </span>
        <span class="flex items-center gap-3 px-4 py-3 rounded-lg text-sm text-gray-400 dark:text-gray-600 cursor-default opacity-50">
            <span class="w-5 text-center">üìú</span> Logs
        </span>
        <span class="flex items-center gap-3 px-4 py-3 rounded-lg text-sm text-gray-400 dark:text-gray-600 cursor-default opacity-50">
            <span class="w-5 text-center">üîß</span> Console
        </span>
        <span class="flex items-center gap-3 px-4 py-3 rounded-lg text-sm text-gray-400 dark:text-gray-600 cursor-default opacity-50">
            <span class="w-5 text-center">üì∏</span> Snapshots
        </span>
        <span class="flex items-center gap-3 px-4 py-3 rounded-lg text-sm text-gray-400 dark:text-gray-600 cursor-default opacity-50">
            <span class="w-5 text-center">‚è±Ô∏è</span> History
        </span>
    </aside>

    {# Main content #}
    <div class="flex-1 min-w-0">

    {# ===== PAGE HEADER ===== #}
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
        <div class="flex items-center gap-4">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white" x-text="machine.hostname || machine.memorable_name || 'Unknown Machine'"></h1>
            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold"
                :class="{
                    'bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-300': machine.status === 'Ready' || machine.status === 'Installed',
                    'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/40 dark:text-yellow-300': machine.status === 'InstallingOS' || machine.status === 'Initializing' || machine.status === 'Writing',
                    'bg-red-100 text-red-800 dark:bg-red-900/40 dark:text-red-300': machine.status === 'Failed',
                    'bg-blue-100 text-blue-800 dark:bg-blue-900/40 dark:text-blue-300': machine.status === 'Discovered' || machine.status === 'ReadyToInstall',
                    'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300': machine.status === 'Offline' || machine.status === 'ExistingOs',
                    'bg-purple-100 text-purple-800 dark:bg-purple-900/40 dark:text-purple-300': !['Ready','Installed','InstallingOS','Initializing','Writing','Failed','Discovered','ReadyToInstall','Offline','ExistingOs'].includes(machine.status)
                }"
                x-text="formatStatus(machine.status)">
            </span>
        </div>
        <div class="flex items-center gap-2">
            {% if is_authenticated %}
            {# Edit button (hidden when editing) #}
            <button x-show="!isEditing"
                @click="startEditing()"
                class="px-4 py-2 bg-transparent border-2 border-blue-600 dark:border-blue-500 hover:bg-blue-500/10 text-blue-700 dark:text-blue-400 text-sm font-medium rounded-lg transition-colors">
                Edit
            </button>

            {# Save/Cancel buttons (shown when editing) #}
            <template x-if="isEditing">
                <div class="flex items-center gap-2">
                    <div x-show="editFormError" class="text-sm text-red-500 mr-2" x-text="editFormError"></div>
                    <button @click="cancelEdit()"
                            :disabled="isSubmitting"
                            class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded-lg transition-colors"
                            :class="{'opacity-50 cursor-not-allowed': isSubmitting}">
                        Cancel
                    </button>
                    <button @click="saveChanges()"
                            :disabled="isSubmitting"
                            class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors"
                            :class="{'opacity-50 cursor-not-allowed': isSubmitting}">
                        <span x-show="isSubmitting">
                            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Saving...
                        </span>
                        <span x-show="!isSubmitting">Save</span>
                    </button>
                </div>
            </template>

            <button
                @click="deleteModalOpen = true"
                class="px-4 py-2 bg-transparent border-2 border-red-600 dark:border-red-700 hover:bg-red-600/10 text-red-600 dark:text-red-400 text-sm font-medium rounded-lg transition-colors">
                Delete
            </button>
            {% endif %}
            <a href="/machines" class="px-4 py-2 bg-transparent border-2 border-gray-900 dark:border-gray-400 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-white/5 text-sm font-medium rounded-lg transition-colors">
                &larr; Machines
            </a>
        </div>
    </div>

    {# ===== ACTIONS ROW (colored Lucide icon buttons) ===== #}
    <div class="flex flex-wrap gap-2 mb-6">
        <button class="inline-flex items-center gap-1.5 px-3 py-2 bg-transparent border-[1.5px] border-blue-600 dark:border-blue-500 rounded-lg text-xs text-blue-700 dark:text-blue-400 hover:bg-blue-500/10 transition-colors">
            <i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i> Reboot
        </button>
        <button class="inline-flex items-center gap-1.5 px-3 py-2 bg-transparent border-[1.5px] border-green-600 dark:border-green-500 rounded-lg text-xs text-green-700 dark:text-green-400 hover:bg-green-500/10 transition-colors">
            <i data-lucide="power" class="w-3.5 h-3.5"></i> Power On
        </button>
        <button class="inline-flex items-center gap-1.5 px-3 py-2 bg-transparent border-[1.5px] border-yellow-600 dark:border-yellow-500 rounded-lg text-xs text-yellow-700 dark:text-yellow-400 hover:bg-yellow-500/10 transition-colors">
            <i data-lucide="circle-stop" class="w-3.5 h-3.5"></i> Shutdown
        </button>
        <button class="inline-flex items-center gap-1.5 px-3 py-2 bg-transparent border-[1.5px] border-orange-600 dark:border-orange-500 rounded-lg text-xs text-orange-700 dark:text-orange-400 hover:bg-orange-500/10 transition-colors">
            <i data-lucide="power-off" class="w-3.5 h-3.5"></i> Power Off
        </button>
        <button class="inline-flex items-center gap-1.5 px-3 py-2 bg-transparent border-0 rounded-lg text-xs text-yellow-700 dark:text-yellow-400 hover:bg-yellow-500/10 transition-colors" style="outline: 2px dashed; outline-offset: -2px;">
            <i data-lucide="move-right" class="w-3.5 h-3.5"></i> Evacuate
        </button>
        <button class="inline-flex items-center gap-1.5 px-3 py-2 bg-transparent border-0 rounded-lg text-xs text-red-700 dark:text-red-400 hover:bg-red-500/10 transition-colors" style="outline: 2px dashed; outline-offset: -2px;">
            <i data-lucide="eraser" class="w-3.5 h-3.5"></i> Reimage
        </button>
    </div>

    {# ===== INFO GRID (4-column: Hostname+IP, Status, Uptime, Created) ===== #}
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="flex flex-col gap-1">
            <span class="text-xs text-gray-500 dark:text-gray-600 uppercase tracking-wider font-medium">Hostname</span>
            <span class="text-sm">
                <span class="text-purple-600 dark:text-purple-400" x-text="(machine.hostname || machine.reported_hostname || 'Not set')"></span>
                <span class="text-gray-500 dark:text-gray-500 tech-mono text-xs ml-1" x-text="machine.ip_address ? '(' + machine.ip_address + ')' : ''"></span>
            </span>
        </div>
        <div class="flex flex-col gap-1">
            <span class="text-xs text-gray-500 dark:text-gray-600 uppercase tracking-wider font-medium">Status</span>
            <span class="text-sm"
                :class="{
                    'text-green-600 dark:text-green-400': machine.status === 'Ready' || machine.status === 'Installed',
                    'text-yellow-600 dark:text-yellow-400': machine.status === 'InstallingOS' || machine.status === 'Initializing' || machine.status === 'Writing',
                    'text-red-600 dark:text-red-400': machine.status === 'Failed',
                    'text-blue-600 dark:text-blue-400': machine.status === 'Discovered' || machine.status === 'ReadyToInstall',
                    'text-gray-600 dark:text-gray-400': !['Ready','Installed','InstallingOS','Initializing','Writing','Failed','Discovered','ReadyToInstall'].includes(machine.status)
                }"
                x-text="formatStatus(machine.status)"></span>
        </div>
        <div class="flex flex-col gap-1">
            <span class="text-xs text-gray-500 dark:text-gray-600 uppercase tracking-wider font-medium">Uptime</span>
            <span class="text-sm text-gray-900 dark:text-gray-200" x-text="machine.uptime || 'Unknown'"></span>
        </div>
        <div class="flex flex-col gap-1">
            <span class="text-xs text-gray-500 dark:text-gray-600 uppercase tracking-wider font-medium">Created</span>
            <span class="text-sm text-gray-900 dark:text-gray-200" x-text="'{{ created_at_formatted }}'"></span>
        </div>
    </div>

    {# ===== TAGS (inline) ===== #}
    <div class="flex flex-wrap gap-2 mb-6">
        <template x-if="machine.tags && machine.tags.length > 0">
            <template x-for="tag in machine.tags" :key="tag.id || tag.name">
                <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-gray-100 dark:bg-[#1a1a1a] border border-gray-200 dark:border-[#333] rounded-full text-sm text-gray-700 dark:text-gray-300">
                    <span x-show="tag.emoji" x-text="tag.emoji" class="text-sm"></span>
                    <span x-text="tag.name"></span>
                    {% if is_authenticated %}
                    <button @click="removeTag(tag)" class="text-gray-400 hover:text-red-500 ml-0.5 transition-colors">&times;</button>
                    {% endif %}
                </span>
            </template>
        </template>
        {% if is_authenticated %}
        <button @click="addTagModal = true"
            class="inline-flex items-center gap-1 px-3 py-1.5 bg-transparent border border-dashed border-gray-300 dark:border-[#444] rounded-full text-sm text-gray-500 dark:text-gray-500 hover:border-purple-500 hover:text-purple-500 dark:hover:border-purple-400 dark:hover:text-purple-400 transition-colors">
            + Tags
        </button>
        {% endif %}
    </div>

    {# ===== DEPLOYMENT PROGRESS (conditional) ===== #}
    <template x-if="machine.status === 'InstallingOS'">
        <template x-if="workflow_info">
            <div class="rounded-xl border-2 border-purple-600 dark:border-purple-600 bg-white dark:bg-[#111] p-5 mb-6"
                 id="workflow-progress-container">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-yellow-100">Deployment Progress</h3>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-300">
                        Template: <span class="font-semibold" x-text="workflow_info.template_name"></span>
                            <template x-if="workflow_info.current_action"> &bull; Current action: <span x-text="workflow_info.current_action"></span></template>
                            <template x-if="workflow_info.current_action == 'Completed via kexec detection'">
                            <span class="ml-2 italic">(Auto-detected successful deployment)</span>
                        </template>
                    </p>
                </div>

                <div class="relative pt-1">
                    <div class="flex mb-2 items-center justify-between">
                            <div>
                            <span id="workflow-state-badge" class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full"
                                    :class="{
                                    'text-red-600 bg-red-200 dark:text-red-200 dark:bg-red-800/30': workflow_info.state === 'STATE_FAILED',
                                    'text-yellow-600 bg-yellow-200 dark:text-yellow-200 dark:bg-yellow-800/30': workflow_info.state !== 'STATE_FAILED'
                                    }">
                                    <span x-text="workflow_info.state === 'STATE_FAILED' ? 'Failed' : 'In Progress'"></span>
                            </span>
                        </div>
                            <div class="text-right">
                            <span id="workflow-progress-percent-text" class="text-xs font-semibold inline-block text-yellow-600 dark:text-yellow-200 workflow-progress-percent"
                                    x-text="workflow_info.progress + '% Complete'">
                            </span>
                        </div>
                    </div>
                    <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-yellow-200 dark:bg-yellow-700/30">
                        <div
                            id="workflow-progress-bar"
                            class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center workflow-overall-progress"
                            :class="workflow_info.state === 'STATE_FAILED' ? 'bg-red-500 dark:bg-red-600' : 'bg-yellow-500 dark:bg-yellow-600'"
                            :style="'width: ' + (workflow_info.progress || 0) + '%;'"
                            :data-progress="workflow_info.progress || 0">
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <h4 class="text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">Task Timeline</h4>
                    <div id="tasks-table-container" class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Action</th>
                                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Started At</th>
                                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Duration</th>
                                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Est. Duration</th>
                                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="tasks-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                    <template x-for="task in workflow_info.tasks" :key="task.name">
                                        <tr :data-task-name="task.name"
                                            :data-task-status="task.status"
                                            :data-started-at="task.started_at"
                                            :data-estimated-duration="task.estimated_duration">
                                            <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white" x-text="task.name"></td>
                                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400" x-text="task.started_at || 'N/A'"></td>
                                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                                <template x-if="task.status === 'STATE_SUCCESS'">
                                                    <span x-text="task.reported_duration + 's'"></span>
                                                </template>
                                                <template x-if="task.status === 'STATE_RUNNING'">
                                                    <div class="relative w-32">
                                                        <div class="overflow-hidden h-2 text-xs flex rounded bg-blue-200 dark:bg-blue-700/30">
                                                            <div class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-blue-500 dark:bg-blue-600 task-progress-bar"
                                                                :style="'width: ' + (taskProgressState[task.name]?.percent || 0) + '%;'"
                                                                :data-progress="taskProgressState[task.name]?.percent || 0">
                                                            </div>
                                                        </div>
                                                        <div class="text-xs mt-1 progress-text" x-text="generateProgressText(taskProgressState[task.name])"></div>
                                                    </div>
                                                </template>
                                                <template x-if="task.status !== 'STATE_SUCCESS' && task.status !== 'STATE_RUNNING'">
                                                    <span>Pending</span>
                                                </template>
                                            </td>
                                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                                <template x-if="task.estimated_duration !== null && task.estimated_duration !== undefined">
                                                    <span x-text="task.estimated_duration + 's'"></span>
                                                </template>
                                                <template x-if="task.estimated_duration === null || task.estimated_duration === undefined">
                                                    <span>N/A</span>
                                                </template>

                                                <template x-if="task.status === 'STATE_SUCCESS' &&
                                                        task.estimated_duration !== null && task.estimated_duration !== undefined &&
                                                        task.reported_duration !== null && task.reported_duration !== undefined &&
                                                        task.reported_duration !== task.estimated_duration">
                                                    <template x-if="task.reported_duration > task.estimated_duration">
                                                        <span class="text-red-500 ml-1" x-text="'(+' + (task.reported_duration - task.estimated_duration) + 's)'"></span>
                                                    </template>
                                                    <template x-if="task.reported_duration < task.estimated_duration">
                                                        <span class="text-green-500 ml-1" x-text="'(-' + (task.estimated_duration - task.reported_duration) + 's)'"></span>
                                                    </template>
                                                </template>
                                            </td>
                                        <td class="px-3 py-2 whitespace-nowrap text-sm">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                                    :class="{
                                                        'bg-green-100 text-green-800 dark:bg-green-400/10 dark:text-green-300': task.status === 'STATE_SUCCESS',
                                                        'bg-red-100 text-red-800 dark:bg-red-400/10 dark:text-red-300': task.status === 'STATE_FAILED',
                                                        'bg-yellow-100 text-yellow-800 dark:bg-yellow-400/10 dark:text-yellow-300': task.status === 'STATE_RUNNING',
                                                        'bg-gray-100 text-gray-800 dark:bg-gray-400/10 dark:text-gray-300': !['STATE_SUCCESS', 'STATE_FAILED', 'STATE_RUNNING'].includes(task.status)
                                                    }">
                                                <span x-text="task.status"></span>
                                            </span>
                                        </td>
                                    </tr>
                                    </template>
                            </tbody>
                        </table>
                    </div>

                    <template x-if="workflow_info && workflow_info.estimated_completion !== null && workflow_info.estimated_completion !== undefined">
                        <div class="mt-4 text-sm text-gray-600 dark:text-gray-300">
                            <p>Estimated completion: <span x-text="workflow_info.estimated_completion"></span></p>
                        </div>
                    </template>
                </div>
            </div>
        </template>
        <template x-if="!workflow_info">
            <div class="rounded-xl border border-gray-200 dark:border-[#1a1a1a] bg-white dark:bg-[#111] p-5 mb-6">
                <p class="text-sm text-gray-500 dark:text-gray-400 italic">Waiting for workflow information...</p>
            </div>
        </template>
    </template>

    {# ===== TWO-COLUMN: INFO + NETWORK ===== #}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
        {# Info Section #}
        <div class="rounded-xl border border-gray-200 dark:border-[#1a1a1a] bg-white dark:bg-[#111] p-5">
            <div class="mb-4">
                <h2 class="text-sm font-semibold text-gray-500 dark:text-gray-500 uppercase tracking-wider">Info</h2>
            </div>
            <div class="grid grid-cols-2 gap-x-6 gap-y-5">
                <div class="flex flex-col gap-1">
                    <span class="text-xs text-gray-500 dark:text-gray-600 uppercase tracking-wider font-medium">Operating System</span>
                    <span class="text-base font-semibold text-gray-900 dark:text-gray-100" x-text="osNames[machine.os_installed] || osNames[machine.os_choice] || machine.os_installed || machine.os_choice || 'Not set'"></span>
                </div>
                <div class="flex flex-col gap-1">
                    <span class="text-xs text-gray-500 dark:text-gray-600 uppercase tracking-wider font-medium flex items-center gap-2">
                        CPU
                        <template x-if="machine.cpu_cores">
                            <span class="inline-flex items-center gap-0.5 text-gray-400 dark:text-gray-500 normal-case tracking-normal">
                                <i data-lucide="cpu" class="w-3 h-3"></i>
                                <span x-text="machine.cpu_cores"></span>
                            </span>
                        </template>
                        <template x-if="machine.cpu_threads && machine.cpu_threads !== machine.cpu_cores">
                            <span class="inline-flex items-center gap-0.5 text-gray-400 dark:text-gray-500 normal-case tracking-normal">
                                <i data-lucide="spool" class="w-3 h-3"></i>
                                <span x-text="machine.cpu_threads"></span>
                            </span>
                        </template>
                    </span>
                    <span class="text-base font-semibold text-gray-900 dark:text-gray-100" x-text="machine.cpu_model || 'Unknown'"></span>
                </div>
                <div class="flex flex-col gap-1">
                    <span class="text-xs text-gray-500 dark:text-gray-600 uppercase tracking-wider font-medium">Memory</span>
                    <span class="text-base font-semibold text-gray-900 dark:text-gray-100" x-text="machine.total_ram_bytes ? formatBytes(machine.total_ram_bytes) : 'Unknown'"></span>
                </div>
                <template x-if="machine.gpus && machine.gpus.length > 0">
                    <div class="flex flex-col gap-1">
                        <span class="text-xs text-gray-500 dark:text-gray-600 uppercase tracking-wider font-medium">GPU</span>
                        <span class="text-base font-semibold text-gray-900 dark:text-gray-100" x-text="machine.gpus[0].name"></span>
                    </div>
                </template>
                <template x-if="machine.bmc_credentials">
                    <div class="flex flex-col gap-1">
                        <span class="text-xs text-gray-500 dark:text-gray-600 uppercase tracking-wider font-medium">BMC State</span>
                        <span class="text-sm text-green-600 dark:text-green-400 font-medium">
                            <span x-text="machine.bmc_credentials.address || 'Configured'"></span>
                            <template x-if="machine.bmc_credentials.bmc_type">
                                <span class="text-gray-400 dark:text-gray-600 ml-1 font-normal" x-text="'(' + machine.bmc_credentials.bmc_type + ')'"></span>
                            </template>
                        </span>
                    </div>
                </template>
            </div>
        </div>

        {# Network Section #}
        <div class="rounded-xl border border-gray-200 dark:border-[#1a1a1a] bg-white dark:bg-[#111] p-5">
            <div class="mb-4">
                <h2 class="text-sm font-semibold text-gray-500 dark:text-gray-500 uppercase tracking-wider">Network</h2>
            </div>
            <div class="grid grid-cols-2 gap-x-6 gap-y-4">
                <div class="flex flex-col gap-1">
                    <span class="text-xs text-gray-500 dark:text-gray-600 uppercase tracking-wider font-medium">Domain</span>
                    <span class="text-sm text-gray-700 dark:text-gray-300" x-text="(function() {
                        var h = machine.hostname || '';
                        var parts = h.split('.');
                        return parts.length > 1 ? parts.slice(1).join('.') : 'N/A';
                    })()"></span>
                </div>
                <div class="flex flex-col gap-1">
                    <span class="text-xs text-gray-500 dark:text-gray-600 uppercase tracking-wider font-medium">MAC</span>
                    <span class="text-sm text-gray-700 dark:text-gray-300 tech-mono" x-text="machine.mac_address || 'N/A'"></span>
                </div>
                <div class="flex flex-col gap-1">
                    <span class="text-xs text-gray-500 dark:text-gray-600 uppercase tracking-wider font-medium">Mode</span>
                    <span class="text-sm text-gray-700 dark:text-gray-300" x-text="ipAddressType"></span>
                </div>
                <div class="flex flex-col gap-1">
                    <span class="text-xs text-gray-500 dark:text-gray-600 uppercase tracking-wider font-medium">Nameservers</span>
                    <span class="text-sm text-gray-700 dark:text-gray-300 tech-mono" x-text="(machine.nameservers && machine.nameservers.length > 0) ? machine.nameservers.join(', ') : 'None'"></span>
                </div>
                <template x-if="machine.proxmox_cluster">
                    <div class="flex flex-col gap-1">
                        <span class="text-xs text-gray-500 dark:text-gray-600 uppercase tracking-wider font-medium">Cluster</span>
                        <span class="text-sm text-purple-600 dark:text-purple-400" x-text="machine.proxmox_cluster"></span>
                    </div>
                </template>
                <template x-if="machine.proxmox_node">
                    <div class="flex flex-col gap-1">
                        <span class="text-xs text-gray-500 dark:text-gray-600 uppercase tracking-wider font-medium">Type</span>
                        <span class="text-sm text-gray-700 dark:text-gray-300">Proxmox</span>
                    </div>
                </template>
                <template x-if="!machine.proxmox_cluster && !machine.proxmox_node">
                    <div class="flex flex-col gap-1">
                        <span class="text-xs text-gray-500 dark:text-gray-600 uppercase tracking-wider font-medium">Memorable Name</span>
                        <span class="text-sm text-gray-700 dark:text-gray-300" x-text="machine.memorable_name || 'Not set'"></span>
                    </div>
                </template>
            </div>
        </div>
    </div>

    {# ===== STORAGE (full width) ===== #}
    <div class="rounded-xl border border-gray-200 dark:border-[#1a1a1a] bg-white dark:bg-[#111] p-5 mb-6">
        <div class="mb-4">
            <h2 class="text-sm font-semibold text-gray-500 dark:text-gray-500 uppercase tracking-wider">Storage</h2>
        </div>
        <template x-if="machine.disks && machine.disks.length > 0">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-gray-100 dark:border-[#222]">
                        <th class="text-left text-[11px] text-gray-400 dark:text-gray-600 uppercase tracking-wider pb-2 font-medium">Device</th>
                        <th class="text-left text-[11px] text-gray-400 dark:text-gray-600 uppercase tracking-wider pb-2 font-medium">Size</th>
                        <th class="text-left text-[11px] text-gray-400 dark:text-gray-600 uppercase tracking-wider pb-2 font-medium">Model</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="disk in machine.disks" :key="disk.device">
                        <tr class="border-b border-gray-50 dark:border-[#1a1a1a] last:border-0">
                            <td class="py-3 text-sm tech-mono text-purple-600 dark:text-purple-400" x-text="disk.device"></td>
                            <td class="py-3 text-sm text-gray-700 dark:text-gray-300" x-text="disk.size_bytes ? formatBytes(disk.size_bytes) : 'Unknown'"></td>
                            <td class="py-3 text-sm text-gray-700 dark:text-gray-300" x-text="disk.model || 'Unknown'"></td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </template>
        <template x-if="!machine.disks || machine.disks.length === 0">
            <p class="text-sm text-gray-400 dark:text-gray-600 italic">No storage devices detected</p>
        </template>
    </div>

    </div>{# /flex-1 content #}
    </div>{# /flex sidebar+content layout #}

    {# ===== DELETE MACHINE MODAL ===== #}
    <div x-show="deleteModalOpen"
         x-cloak
         class="fixed inset-0 z-50 overflow-y-auto"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div @click="deleteModalOpen = false" class="fixed inset-0 bg-gray-500 dark:bg-gray-900 bg-opacity-75 dark:bg-opacity-75 transition-opacity" aria-hidden="true"></div>

            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-red-600 dark:text-red-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
                                Delete Machine
                            </h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500 dark:text-gray-400">
                                    Are you sure you want to delete this machine? This action cannot be undone.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button @click="deleteMachine()"
                            :disabled="isDeleting"
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm"
                            :class="{'opacity-50 cursor-not-allowed': isDeleting}">
                        <span x-show="isDeleting">
                            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Deleting...
                        </span>
                        <span x-show="!isDeleting">Delete</span>
                    </button>
                    <button @click="deleteModalOpen = false"
                            :disabled="isDeleting"
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"
                            :class="{'opacity-50 cursor-not-allowed': isDeleting}">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
  // Define helper functions in the script scope
  const formatStatus = (s) => s ? s.replace(/([a-z])([A-Z])/g, '$1 $2').replace(/ (To|Of|In|On|At|By|For|The|A|An) /g, (m) => m.toLowerCase()) : s;
  const formatBytes = (bytes, decimals = 1) => {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const dm = decimals < 0 ? 0 : decimals;
      const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
  };
  const findMatchingStreamTasks = (fileName) => {
      const taskRows = document.querySelectorAll('#tasks-table-body tr[data-task-name]');
      const matchingRows = [];
      taskRows.forEach(row => {
          const taskNameAttr = row.getAttribute('data-task-name').toLowerCase();
          const fileNameLower = (fileName || '').toLowerCase();
          if (taskNameAttr.startsWith('stream image') || (fileNameLower && taskNameAttr.includes(fileNameLower))) {
              if (!taskNameAttr.includes('complete') && !taskNameAttr.includes('failed')) {
                  matchingRows.push(row);
              }
          }
      });
      if (matchingRows.length === 0) {
          taskRows.forEach(row => {
              const taskNameAttr = row.getAttribute('data-task-name').toLowerCase();
              if (taskNameAttr.startsWith('stream image')) {
                  if (!taskNameAttr.includes('complete') && !taskNameAttr.includes('failed')) {
                      matchingRows.push(row);
                  }
              }
          });
      }
      return matchingRows;
  };
  const startProgressAnimation = (element) => {
      if (element && !element.classList.contains('animate-progress')) {
          element.classList.add('animate-progress');
      }
  };
  const stopProgressAnimation = (element) => {
       if (element) {
          element.classList.remove('animate-progress');
      }
  };

  // Alpine component function
  function machineDetailsData() {
    return {
        // --- Properties ---
        machine: {
            id: null,
            status: 'Loading...',
            hostname: null,
            ip_address: null,
            mac_address: null,
            memorable_name: null,
            os_choice: null,
            disks: [],
            nameservers: [],
            tags: [],
            last_deployment_duration: null,
            bmc_credentials: null
        },
        workflow_info: null,
        machineId: '',
        machineIp: '',
        taskProgressState: {},
        evtSource: null,
        selectedStatus: '',
        fetchDebounceTimer: null,
        error: null,

        // Inline edit properties
        isEditing: false,
        editForm: {
            hostname: '',
            memorable_name: '',
            mac_address: '',
            ip_address: '',
            os_choice: ''
        },
        editFormError: '',
        isSubmitting: false,

        // Delete modal properties
        deleteModalOpen: false,
        isDeleting: false,

        // Tag modal
        addTagModal: false,

        // IP Address Type
        ipAddressType: 'Unknown',

        // OS display name mapping (loaded from /static/os_names.json)
        osNames: {},

        // --- Methods ---
        startEditing() {
            this.editForm = {
                hostname: this.machine.hostname || '',
                memorable_name: this.machine.memorable_name || '',
                mac_address: this.machine.mac_address || '',
                ip_address: this.machine.ip_address || '',
                os_choice: this.machine.os_choice || ''
            };
            this.editFormError = '';
            this.isEditing = true;
        },

        cancelEdit() {
            this.isEditing = false;
            this.editFormError = '';
        },

        saveChanges() {
            this.isSubmitting = true;
            this.editFormError = '';

            // Validate MAC address format
            if (this.editForm.mac_address && !/^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$/.test(this.editForm.mac_address)) {
                this.editFormError = 'Invalid MAC address format. Please use XX:XX:XX:XX:XX:XX format.';
                this.isSubmitting = false;
                return;
            }

            // Validate IP address format if provided
            if (this.editForm.ip_address && !/^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(this.editForm.ip_address)) {
                this.editFormError = 'Invalid IP address format. Must be a valid IPv4 address.';
                this.isSubmitting = false;
                return;
            }

            // Validate hostname format if provided
            if (this.editForm.hostname && !/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(this.editForm.hostname)) {
                this.editFormError = 'Invalid hostname format. Must follow RFC-1123 standard.';
                this.isSubmitting = false;
                return;
            }

            fetch(`/api/machines/${this.machine.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(this.editForm)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.message || 'Failed to update machine');
                    });
                }
                return response.json();
            })
            .then(data => {
                Object.assign(this.machine, this.editForm);
                if (window.showToast) {
                    window.showToast(`Machine updated successfully`, 'success');
                }
                this.isEditing = false;
            })
            .catch(error => {
                this.editFormError = error.message || 'An error occurred while updating the machine';
                console.error('Error updating machine:', error);
            })
            .finally(() => {
                this.isSubmitting = false;
            });
        },

        deleteMachine() {
            this.isDeleting = true;

            fetch(`/api/machines/${this.machine.id}`, {
                method: 'DELETE',
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || `HTTP error! status: ${response.status}`);
                    });
                }
                return response.text();
            })
            .then(() => {
                if (window.showToast) {
                    window.showToast(`Machine deleted successfully`, 'success');
                }
                window.location.href = '/machines';
            })
            .catch(error => {
                if (window.showToast) {
                    window.showToast(`Failed to delete machine: ${error.message}`, 'error');
                }
                console.error('Error deleting machine:', error);
                this.deleteModalOpen = false;
            })
            .finally(() => {
                this.isDeleting = false;
            });
        },

        removeTag(tag) {
            // Tag removal - will be wired up when tag API exists
            console.log('Remove tag:', tag);
        },

        initSSE() {
            console.log("Initializing SSE connection...");
            if (this.evtSource && this.evtSource.readyState !== EventSource.CLOSED) {
                 console.log("SSE connection already open.");
                 return;
            }
            if (!this.machineId || this.machineId === 'error') {
                 console.warn("Cannot initialize SSE without a valid machine ID.");
                 return;
            }

            if (this.evtSource) {
                this.evtSource.close();
            }

            console.log(`Attempting SSE connection to /api/events for machine ${this.machineId}`);
            this.evtSource = new EventSource('/api/events');
            window.globalEvtSource = this.evtSource;

            this.evtSource.onopen = () => {
                console.log("SSE connection opened.");
                this.error = null;
            };

            this.evtSource.onerror = (err) => {
                console.error('Global SSE connection error:', err);
                console.log('SSE connection error. Browser will attempt to reconnect automatically.');
                this.error = "Connection lost. Attempting to reconnect...";
            };

            this.evtSource.onmessage = (event) => {
                 console.log("Generic SSE message received:", event.data);
            };

            this.evtSource.addEventListener('machine_updated', (event) => {
                console.log('Received machine_updated event:', event.data);
                try {
                    const eventData = JSON.parse(event.data);
                    clearTimeout(this.fetchDebounceTimer);

                    if (eventData.machine) {
                        console.log('Processing full data from SSE event.');
                        if (eventData.machine.id === this.machine.id) {
                            this.machine = eventData.machine;
                            this.workflow_info = eventData.workflow_info || null;
                            console.log('Updated machine state from SSE event:', this.machine);
                            console.log('Updated workflow info from SSE event:', this.workflow_info);
                        } else {
                            console.warn('Received full machine_updated event for a different machine ID:', eventData.machine.id, 'Expected:', this.machine.id);
                        }
                    } else if (eventData.id === this.machine.id) {
                        console.log(`Debouncing fetch for machine ${eventData.id}...`);
                        this.fetchDebounceTimer = setTimeout(() => {
                            console.log(`Executing debounced fetch for machine ${eventData.id}`);
                            fetch(`/api/machines/${eventData.id}`)
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error(`Network response was not ok: ${response.statusText} (${response.status})`);
                                    }
                                    return response.json();
                                })
                                .then(fullData => {
                                    console.log('Fetched full data after event:', fullData);
                                    if (fullData.machine && fullData.machine.id === this.machine.id) {
                                        this.machine = fullData.machine;
                                        this.workflow_info = fullData.workflow_info || null;
                                        console.log('Updated machine state via fetch:', this.machine);
                                        console.log('Updated workflow info via fetch:', this.workflow_info);
                                        this.error = null;
                                    } else if (fullData.machine && fullData.machine.id !== this.machine.id) {
                                        console.warn('Fetched data belongs to a different machine ID:', fullData.machine.id, 'Expected:', this.machine.id);
                                    } else {
                                        console.warn('Fetched data missing machine structure or ID mismatch:', fullData);
                                    }
                                })
                                .catch(error => {
                                    console.error('Error fetching full machine data:', error);
                                    this.error = `Failed to fetch update for ${eventData.id}: ${error.message}. Retrying on next event.`;
                                });
                        }, 32);
                    } else {
                        console.warn('Ignoring machine_updated event: ID mismatch or invalid format.', 'Event ID:', eventData.id, 'Current Machine ID:', this.machine.id);
                    }
                } catch (e) {
                    console.error('Error parsing machine_updated event data:', e, 'Raw data:', event.data);
                    this.error = "Error processing update event.";
                }
            });

            this.evtSource.addEventListener('machine_discovered', (event) => {
                console.log("SSE Listener: machine_discovered received:", event.data);
            });

            this.evtSource.addEventListener('ip_download_progress', (event) => {
                console.log("[PROGRESS_LISTENER] Listener is active!");
                console.log("SSE Listener: ip_download_progress received:", event.data);
                try {
                    const progressData = JSON.parse(event.data);
                    if (progressData.machine_id === this.machineId) {
                         console.log("Matching machine ID for progress update.");
                         const taskName = progressData.file_name || 'stream image';
                         const bytesDownloaded = progressData.bytes_downloaded;
                         const totalSize = progressData.total_size;
                         const calculatedProgress = (totalSize > 0) ? (bytesDownloaded / totalSize * 100) : 0;

                         if (this.taskProgressState[taskName] !== undefined) {
                            this.taskProgressState[taskName] = {
                                percent: calculatedProgress,
                                bytesDownloaded: bytesDownloaded,
                                totalSize: totalSize
                            };
                            console.log(`Updated taskProgressState for ${taskName}:`, JSON.stringify(this.taskProgressState[taskName]));
                         } else {
                            console.warn(`Task state key not found for progress update: ${taskName}`);
                         }
                     }
                } catch (e) {
                     console.error('Error processing ip_download_progress event:', e, event.data);
                }
            });

             this.evtSource.addEventListener('task_progress', (event) => {
                 console.log("SSE Listener: task_progress received:", event.data);
             });

        },

        initializeComponent() {
            console.log("Initializing Machine Details Component");

            const machineDataElement = document.getElementById('machine-data-json');
            const workflowDataElement = document.getElementById('workflow-data-json');

            if (machineDataElement && machineDataElement.textContent) {
                try {
                    this.machine = JSON.parse(machineDataElement.textContent);
                    console.log("Machine data loaded from JSON:", this.machine);

                    this.machineId = this.machine.id;
                    this.machineIp = this.machine.ip_address;
                    console.log("Machine ID set to:", this.machineId);

                    this.ipAddressType = '{{ ip_address_type | safe }}';
                    console.log("IP Address Type:", this.ipAddressType);

                    this.editForm = { ...this.machine };
                } catch (e) {
                    console.error("Failed to parse machine JSON:", e);
                    this.machine = { id: 'error', ip_address: 'error', status: 'Error parsing data', hostname: 'Error' };
                    this.workflow_info = null;
                    this.machineId = 'error';
                    this.machineIp = 'error';
                }
            } else {
                console.error("Machine data not found in script tag.");
                this.machine = { id: 'error', ip_address: 'error', status: 'Error parsing data', hostname: 'Error' };
                this.workflow_info = null;
                this.machineId = 'error';
                this.machineIp = 'error';
            }

            if (workflowDataElement && workflowDataElement.textContent) {
                try {
                    this.workflow_info = JSON.parse(workflowDataElement.textContent);
                    console.log("Workflow info loaded from JSON:", this.workflow_info);
                } catch (e) {
                    console.error("Failed to parse workflow JSON:", e);
                    this.workflow_info = null;
                }
            }

            this.$nextTick(() => {
                if (this.workflow_info && this.workflow_info.tasks) {
                    this.workflow_info.tasks.forEach(task => {
                        if (this.taskProgressState[task.name] === undefined) {
                            this.taskProgressState[task.name] = {
                                percent: task.progress || 0,
                                bytesDownloaded: 0,
                                totalSize: 0
                            };
                        }
                    });
                    console.log("Initial taskProgressState:", JSON.stringify(this.taskProgressState));
                }

                // Initialize Lucide icons after Alpine renders
                if (window.lucide) {
                    lucide.createIcons();
                }
            });

            // Load OS display names
            fetch('/static/os_names.json')
                .then(r => r.json())
                .then(names => { this.osNames = names; })
                .catch(e => console.warn('Could not load OS names:', e));

            this.initSSE();
        },

        generateProgressText(progressInfo) {
            if (!progressInfo) {
                return '0%';
            }
            const percent = progressInfo.percent || 0;
            if (progressInfo.totalSize > 0) {
                const downloadedMB = (progressInfo.bytesDownloaded / (1024 * 1024)).toFixed(1);
                const totalMB = (progressInfo.totalSize / (1024 * 1024)).toFixed(1);
                return `${percent.toFixed(1)}% (${downloadedMB}/${totalMB} MB)`;
            } else {
                return `${percent.toFixed(1)}%`;
            }
        },

        fetchMachineData() {
            if (!this.machineId) return;
            this.evtSource.addEventListener('ip_download_progress', (event) => {
                console.log("[PROGRESS_LISTENER] Listener is active!");
                console.log("SSE Listener: ip_download_progress received:", event.data);
                try {
                    const progressData = JSON.parse(event.data);
                    if (progressData.machine_id === this.machineId) {
                         console.log("Matching machine ID for progress update.");
                         const taskName = progressData.file_name || 'stream image';
                         const bytesDownloaded = progressData.bytes_downloaded;
                         const totalSize = progressData.total_size;
                         const calculatedProgress = (totalSize > 0) ? (bytesDownloaded / totalSize * 100) : 0;

                         if (this.taskProgressState[taskName] !== undefined) {
                            this.taskProgressState[taskName] = {
                                percent: calculatedProgress,
                                bytesDownloaded: bytesDownloaded,
                                totalSize: totalSize
                            };
                            console.log(`Updated taskProgressState for ${taskName}:`, JSON.stringify(this.taskProgressState[taskName]));
                         } else {
                            console.warn(`Task state key not found for progress update: ${taskName}`);
                         }
                     }
                } catch (e) {
                     console.error('Error processing ip_download_progress event:', e, event.data);
                }
            });

             this.evtSource.addEventListener('task_progress', (event) => {
                 console.log("SSE Listener: task_progress received:", event.data);
             });

        }
    };
  }

  document.addEventListener('DOMContentLoaded', () => {
    console.log("Machine details page loaded, Alpine component should initialize shortly.");
  });
</script>
{% endblock %}
