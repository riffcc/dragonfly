{% extends "base.html" %}

{% block content %}

<div x-data="machineDetailsData()" 
    x-init="initializeComponent()">

    {# Embed JSON data using script tags #}
    <script id="machine-data-json" type="application/json">
        {{ machine_json | safe }} {# Use safe within script tag #}
    </script>
    <script id="workflow-data-json" type="application/json">
        {{ workflow_info_json | safe }} {# Use safe within script tag #}
    </script>

    <div class="flex justify-between items-center mb-8">
        <h1 class="text-4xl font-bold text-black dark:text-white" x-text="machine.hostname || 'Loading...'"></h1>
        <div class="flex space-x-3">
            {% if is_authenticated %}
            {# Show Edit button when not editing #}
            <button x-show="!isEditing" 
                @click="startEditing()"
                class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium rounded-md"
            >
                Edit
            </button>
            
            {# Show Save and Cancel buttons when editing #}
            <template x-if="isEditing">
                <div>
                    <!-- Error Message -->
                    <div x-show="editFormError" class="text-sm text-red-600 dark:text-red-400 mb-2 text-right" x-text="editFormError"></div>
                    <div class="flex justify-end space-x-3">
                        <button @click="cancelEdit()" 
                                :disabled="isSubmitting"
                                class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded-md"
                                :class="{'opacity-50 cursor-not-allowed': isSubmitting}">
                            Cancel
                        </button>
                        <button @click="saveChanges()" 
                                :disabled="isSubmitting"
                                class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-md"
                                :class="{'opacity-50 cursor-not-allowed': isSubmitting}">
                            <span x-show="isSubmitting">
                                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Saving...
                            </span>
                            <span x-show="!isSubmitting">Save</span>
                        </button>
                    </div>
                </div>
            </template>
            
            {# Always show Delete button if authenticated #}
            <button 
                @click="deleteModalOpen = true" 
                class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-md"
            >
                Delete
            </button>
            <a href="/machines" class="inline-flex items-center px-1 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <div class="text-sm ml-1 mr-1"><- Machines</div>
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Deployment Progress Section - Use x-if based on Alpine data -->
    <template x-if="machine.status === 'InstallingOS'">
        <template x-if="workflow_info">
            <div class="rounded rounded-xl border border-black dark:border-purple-600 border-2 p-4 sm:p-6 mb-4"
                 id="workflow-progress-container"> {# Keep ID for potential direct targeting #}
                <div class="mb-4">
                    <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-yellow-100">Deployment Progress</h3>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-300">
                        Template: <span class="font-semibold" x-text="workflow_info.template_name"></span>
                            <template x-if="workflow_info.current_action"> ‚Ä¢ Current action: <span x-text="workflow_info.current_action"></span></template>
                            <template x-if="workflow_info.current_action == 'Completed via kexec detection'">
                            <span class="ml-2 italic">(Auto-detected successful deployment)</span>
                        </template>
                    </p>
                </div>
                
                {# ... rest of the progress section, binding to workflow_info ... #}
                <div class="relative pt-1">
                    <div class="flex mb-2 items-center justify-between">
                            <div>
                            <span id="workflow-state-badge" class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full"
                                    :class="{
                                    'text-red-600 bg-red-200 dark:text-red-200 dark:bg-red-800/30': workflow_info.state === 'STATE_FAILED',
                                    'text-yellow-600 bg-yellow-200 dark:text-yellow-200 dark:bg-yellow-800/30': workflow_info.state !== 'STATE_FAILED'
                                    }">
                                    <span x-text="workflow_info.state === 'STATE_FAILED' ? 'Failed' : 'In Progress'"></span>
                            </span>
                        </div>
                            <div class="text-right">
                            <span id="workflow-progress-percent-text" class="text-xs font-semibold inline-block text-yellow-600 dark:text-yellow-200 workflow-progress-percent"
                                    x-text="workflow_info.progress + '% Complete'">
                            </span>
                        </div>
                    </div>
                    <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-yellow-200 dark:bg-yellow-700/30">
                        <div
                            id="workflow-progress-bar"
                            class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center workflow-overall-progress"
                            :class="workflow_info.state === 'STATE_FAILED' ? 'bg-red-500 dark:bg-red-600' : 'bg-yellow-500 dark:bg-yellow-600'"
                            :style="'width: ' + (workflow_info.progress || 0) + '%;'"
                            :data-progress="workflow_info.progress || 0">
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <h4 class="text-sm font-medium leading-6 text-gray-700 dark:text-gray-200 mb-2">Task Timeline</h4>
                    <div id="tasks-table-container" class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Action</th>
                                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Started At</th>
                                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Duration</th>
                                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Est. Duration</th>
                                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="tasks-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                    {# Use x-for to loop through Alpine data #}
                                    <template x-for="task in workflow_info.tasks" :key="task.name">
                                        <tr :data-task-name="task.name"
                                            :data-task-status="task.status"
                                            :data-started-at="task.started_at"
                                            :data-estimated-duration="task.estimated_duration">
                                            <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white" x-text="task.name"></td>
                                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400" x-text="task.started_at || 'N/A'"></td>
                                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                                <template x-if="task.status === 'STATE_SUCCESS'">
                                                    <span x-text="task.reported_duration + 's'"></span>
                                                </template>
                                                <template x-if="task.status === 'STATE_RUNNING'">
                                                    <div class="relative w-32">
                                                        <div class="overflow-hidden h-2 text-xs flex rounded bg-blue-200 dark:bg-blue-700/30">
                                                            <div class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-blue-500 dark:bg-blue-600 task-progress-bar"
                                                                :style="'width: ' + (taskProgressState[task.name]?.percent || 0) + '%;'"
                                                                :data-progress="taskProgressState[task.name]?.percent || 0">
                                                            </div>
                                                        </div>
                                                        <div class="text-xs mt-1 progress-text" x-text="generateProgressText(taskProgressState[task.name])"></div>
                                                    </div>
                                                </template>
                                                <template x-if="task.status !== 'STATE_SUCCESS' && task.status !== 'STATE_RUNNING'">
                                                    <span>Pending</span>
                                                </template>
                                            </td>
                                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                                {# Display estimated duration first - Use Alpine #}
                                                <template x-if="task.estimated_duration !== null && task.estimated_duration !== undefined">
                                                    <span x-text="task.estimated_duration + 's'"></span>
                                                </template>
                                                <template x-if="task.estimated_duration === null || task.estimated_duration === undefined">
                                                    <span>N/A</span>
                                                </template>

                                                {# Separately check and display comparison if possible and relevant - Use Alpine #}
                                                <template x-if="task.status === 'STATE_SUCCESS' && 
                                                        task.estimated_duration !== null && task.estimated_duration !== undefined && 
                                                        task.reported_duration !== null && task.reported_duration !== undefined &&
                                                        task.reported_duration !== task.estimated_duration">
                                                    <template x-if="task.reported_duration > task.estimated_duration">
                                                        <span class="text-red-500 ml-1" x-text="'(+' + (task.reported_duration - task.estimated_duration) + 's)'"></span>
                                                    </template>
                                                    <template x-if="task.reported_duration < task.estimated_duration">
                                                        <span class="text-green-500 ml-1" x-text="'(-' + (task.estimated_duration - task.reported_duration) + 's)'"></span>
                                                    </template>
                                                </template>
                                            </td>
                                        <td class="px-3 py-2 whitespace-nowrap text-sm">
                                            {# Use Alpine :class for status styling #}
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                                    :class="{
                                                        'bg-green-100 text-green-800 dark:bg-green-400/10 dark:text-green-300': task.status === 'STATE_SUCCESS',
                                                        'bg-red-100 text-red-800 dark:bg-red-400/10 dark:text-red-300': task.status === 'STATE_FAILED',
                                                        'bg-yellow-100 text-yellow-800 dark:bg-yellow-400/10 dark:text-yellow-300': task.status === 'STATE_RUNNING',
                                                        'bg-gray-100 text-gray-800 dark:bg-gray-400/10 dark:text-gray-300': !['STATE_SUCCESS', 'STATE_FAILED', 'STATE_RUNNING'].includes(task.status)
                                                    }">
                                                <span x-text="task.status"></span> {# Use Alpine x-text #}
                                            </span>
                                        </td>
                                    </tr>
                                    </template>
                            </tbody>
                        </table>
                    </div>

                    {# Display estimated completion using Alpine #}
                    <template x-if="workflow_info && workflow_info.estimated_completion !== null && workflow_info.estimated_completion !== undefined">
                        <div class="mt-4 text-sm text-gray-600 dark:text-gray-300">
                            <p>Estimated completion: <span x-text="workflow_info.estimated_completion"></span></p>
                        </div>
                    </template>
                </div>
            </div>
        </template>
        <template x-if="!workflow_info">
            <div class="border-t border-gray-200 dark:border-gray-700 p-4 sm:p-6 bg-gray-50 dark:bg-gray-800/30">
                <p class="text-sm text-gray-500 dark:text-gray-400 italic">Waiting for workflow information...</p>
            </div>
        </template>
    </template>

    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
        <div class="bg-blue-100/20 border border-purple-500 rounded-xl shadow-lg p-4 space-y-2">
            <h3 class="text-center text-lg font-semibold text-black dark:text-white">üß¨ Details</h3>
            <div class="text-xl mt-8 text-gray-900 dark:text-gray-400">
                <div><span class="font-bold text-purple-900 dark:text-purple-100">Operating System:</span> Ubuntu 24.04</div>
                <div><span class="font-bold text-purple-900 dark:text-purple-100">CPU:</span> AMD Ryzen 7 7800X3D (8 cores, 16 threads)</div>
                <div><span class="font-bold text-purple-900 dark:text-purple-100">GPU:</span> NVIDIA RTX 4070 Ti</div>
                <div><span class="font-bold text-purple-900 dark:text-purple-100">RAM:</span> 64 GiB</div>
                <div><span class="font-bold text-purple-900 dark:text-purple-100">Created:</span> 2025-04-03 23:34:42 UTC</div>
                <div><span class="font-bold text-purple-900 dark:text-purple-100">Updated:</span> 2025-04-04 00:21:25 UTC</div>
            </div>
        </div>
        
        <div class="bg-blue-100/20 border border-indigo-500 rounded-xl shadow-lg p-4 space-y-2">
            <h3 class="text-center text-lg font-semibold text-black dark:text-white">‚öôÔ∏è Actions</h3> 
            <div class="grid grid-cols-3 grid-rows-2 gap-2 mt-8 min-h-[120px]"> {# Explicit grid with rows #}
                <div class="flex items-center justify-center">
                    <button class="w-full h-16 border border-indigo-500 hover:bg-indigo-600 text-black dark:text-white rounded-md">Reboot</button>
                </div>
                <div class="flex items-center justify-center">
                    <button class="w-full h-16 border border-red-700 hover:bg-red-600 text-black dark:text-white rounded-md">Power on</button>
                </div>
                <div class="flex items-center justify-center">
                    <button class="w-full h-16 border border-green-700 hover:bg-green-600 text-black dark:text-white rounded-md">Shutdown</button>
                </div>
                <div class="flex items-center justify-center">
                    <button class="w-full h-16 border border-green-700 hover:bg-green-600 text-black dark:text-white rounded-md">Power off</button>
                </div>
                <div class="flex items-center justify-center">
                    <button class="w-full h-16 border border-red-700 hover:bg-red-600 text-black dark:text-white rounded-md">Evacuate</button>
                </div>
                <div class="flex items-center justify-center">
                    <button class="w-full h-16 border border-yellow-700 hover:bg-yellow-600 text-black dark:text-white rounded-md">Reimage</button>
                </div>
            </div>
        </div>
        <div class="bg-[#e6e6ff] dark:bg-[#112240] border border-cyan-500 rounded-xl shadow-lg p-4 space-y-2">
            <h3 class="text-center text-lg font-semibold text-black dark:text-cyan-300">üñß <span class="dark:text-white">Network</span></h3>
            <div class="text-xl mt-8 text-gray-900 dark:text-gray-300 ml-4">
            <div><span class="font-bold dark:text-cyan-100">Hostname:</span> blackberry</div>
            <div><span class="font-bold dark:text-cyan-100">Domain:</span> lon.riff.cc</div>
            <div><span class="font-bold dark:text-cyan-100">Memorable Name:</span> </div>
            <div><span class="font-bold dark:text-cyan-100">IP:</span> 10.1.0.5</div>
            <div><span class="font-bold dark:text-cyan-100">Network:</span> 10.1.0.0/24</div>
            <div><span class="font-bold dark:text-cyan-100">MAC:</span> bc:24:11:b9:54:89</div>
            <div><span class="font-bold dark:text-cyan-100">Mode:</span> DHCP</div>
            </div>
        </div>

        <!-- Tags -->
        <div class="bg-[#fff5e6] dark:bg-[#281e36] border border-pink-500 rounded-xl shadow-lg p-4 space-y-2">
            <h3 class="text-center text-lg font-semibold">üè∑ Tags</h3>
            <div class="flex flex-wrap gap-2 justify-center text-lg text-black dark:text-pink-100">
                <div class="flex items-center gap-0 rounded-md px-1 py-1 border border-green-500">
                    <span class="rounded px-1">üåâ gpu</span>
                    <a href="/machines?machine_id={{ machine.id }}&tag=gpu&action=delete">
                        <span class="text-xs text-gray-400 px-1">x</span>
                    </a>
                </div>
                <div class="flex items-center gap-0 rounded-md px-1 py-1 border border-red-500">
                    <span class="rounded px-1">üßë‚Äçüî¨ ai</span>
                    <span class="text-xs text-gray-400 px-1">x</span>
                </div>
                <div class="flex items-center gap-0 rounded-md px-1 py-1 border border-purple-500">
                    <span class="rounded px-1">üîí 2fa</span>
                    <span class="text-xs text-gray-400 px-1">x</span>
                </div>
                <div class="flex items-center gap-0 rounded-md px-1 py-1 border border-pink-500">
                    <span class="rounded px-1">üêâ dragonfly-server</span>
                    <span class="text-xs text-gray-400 px-1">x</span>
                </div>
            </div>
        </div>

        <!-- Storage Card - Double width on physical hosts -->
        <div class="bg-green-100/20 dark:bg-[#221c2c] border border-yellow-500 rounded-xl shadow-lg p-1 space-y-1">
            <h3 class="text-center text-lg font-semibold text-black dark:text-white p-4">üíæ Storage</h3>
            <div class="overflow-x-auto">
            <table class="w-full text-sm text-black dark:text-yellow-100">
                <thead class="text-xs uppercase bg-blue-100 dark:bg-red-900/10 border-b border-yellow-800/30">
                <tr>
                    <th class="px-4 py-2 text-left">Device</th>
                    <th class="px-4 py-2 text-left">Size</th>
                    <th class="px-4 py-2 text-left">Model name</th>
                </tr>
                </thead>
                <tbody>
                <tr class="border-b border-yellow-800/20">
                    <td class="px-4 py-2 font-medium">/dev/nvme0n1</td>
                    <td class="px-4 py-2">3.64 TB</td>
                    <td class="px-4 py-2">WD_BLACK SN850X</td>
                </tr>
                <tr>
                    <td class="px-4 py-2 font-medium">/dev/nvme1n1</td>
                    <td class="px-4 py-2">1.82 TB</td>
                    <td class="px-4 py-2">Samsung 990 Pro</td>
                </tr>
                </tbody>
            </table>
            </div>
        </div>

        <!-- Cluster Details Card -->
        <div class="bg-white dark:bg-[#1e293b] shadow overflow-hidden sm:rounded-lg border border-transparent dark:border-white dark:border-opacity-5">
            <h3 class="text-center text-lg font-semibold text-black dark:text-white p-4">ü´Ä Status</h3>
            <div class="text-lg text-grey-900 dark:text-gray-300 ml-4 mb-8">
                <div>
                    <span class="font-bold text-cyan-900 dark:text-cyan-100">State:</span>
                    <span class="font-semibold rounded rounded-xl border border-green-500 px-1 py-0 text-md">Ready</span>
                </div>
                <div>
                    <span class="font-bold text-cyan-900 dark:text-cyan-100">BMC State:</span>
                    <span class="font-semibold rounded rounded-xl border border-green-500 px-1 py-0 text-md">Ready</span>
                </div>
                <div><span class="font-bold text-cyan-900 dark:text-cyan-100">Uptime:</span> 4 days, 12 hours, 34 minutes</div>
                <div><span class="font-bold text-cyan-900 dark:text-cyan-100">Cluster:</span> SpaceTempAgency</div>
                <div><span class="font-bold text-cyan-900 dark:text-cyan-100">Cluster type:</span> Proxmox</div>
            </div>
        </div>
        {# Add styles for the custom border width at the top of the file #}
        <style>
            .border-3 {
                border-width: 3px !important;
            }
        </style>
    </div>
    
    <!-- Delete Machine Modal (Moved INSIDE x-data scope) -->
    <div x-show="deleteModalOpen" 
         x-cloak 
         class="fixed inset-0 z-50 overflow-y-auto"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div @click="deleteModalOpen = false" class="fixed inset-0 bg-gray-500 dark:bg-gray-900 bg-opacity-75 dark:bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            
            <!-- Modal Content -->
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-red-600 dark:text-red-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
                                Delete Machine
                            </h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500 dark:text-gray-400">
                                    Are you sure you want to delete this machine? This action cannot be undone.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button @click="deleteMachine()" 
                            :disabled="isDeleting"
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm"
                            :class="{'opacity-50 cursor-not-allowed': isDeleting}">
                        <span x-show="isDeleting">
                            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Deleting...
                        </span>
                        <span x-show="!isDeleting">Delete</span>
                    </button>
                    <button @click="deleteModalOpen = false" 
                            :disabled="isDeleting"
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"
                            :class="{'opacity-50 cursor-not-allowed': isDeleting}">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
  // Define helper functions in the script scope
  const formatBytes = (bytes, decimals = 1) => { 
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const dm = decimals < 0 ? 0 : decimals;
      const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
  };
  const findMatchingStreamTasks = (fileName) => { 
      const taskRows = document.querySelectorAll('#tasks-table-body tr[data-task-name]');
      const matchingRows = [];
      taskRows.forEach(row => {
          const taskNameAttr = row.getAttribute('data-task-name').toLowerCase();
          const fileNameLower = (fileName || '').toLowerCase();
          if (taskNameAttr.startsWith('stream image') || (fileNameLower && taskNameAttr.includes(fileNameLower))) {
              if (!taskNameAttr.includes('complete') && !taskNameAttr.includes('failed')) {
                  matchingRows.push(row);
              }
          }
      });
      if (matchingRows.length === 0) {
          taskRows.forEach(row => {
              const taskNameAttr = row.getAttribute('data-task-name').toLowerCase();
              if (taskNameAttr.startsWith('stream image')) {
                  if (!taskNameAttr.includes('complete') && !taskNameAttr.includes('failed')) {
                      matchingRows.push(row);
                  }
              }
          });
      }
      return matchingRows;
  };
  const startProgressAnimation = (element) => {
      if (element && !element.classList.contains('animate-progress')) {
          element.classList.add('animate-progress');
      }
  };
  const stopProgressAnimation = (element) => {
       if (element) {
          element.classList.remove('animate-progress');
      }
  };

  // Alpine component function
  function machineDetailsData() { 
    return {
        // --- Properties ---
        machine: { 
            id: null, 
            status: 'Loading...', 
            hostname: null, 
            ip_address: null, 
            mac_address: null, 
            memorable_name: null,
            os_choice: null, 
            disks: [], 
            nameservers: [],
            last_deployment_duration: null,
            bmc_credentials: null // Add other keys as needed by template
        }, 
        workflow_info: null,
        machineId: '', 
        machineIp: '',
        taskProgressState: {},
        evtSource: null,
        selectedStatus: '', // For the status update modal
        fetchDebounceTimer: null, // Timer for debouncing fetches
        error: null,

        // Inline edit properties
        isEditing: false, // Replaces editModalOpen
        editForm: { // Keep this to hold edits
            hostname: '',
            memorable_name: '',
            mac_address: '',
            ip_address: '',
            os_choice: ''
        },
        editFormError: '',
        isSubmitting: false,
        
        // Delete modal properties
        deleteModalOpen: false,
        isDeleting: false,
        
        // IP Address Type
        ipAddressType: 'Unknown',
        
        // --- Methods --- 
        // Renamed from openEditModal
        startEditing() {
            // Populate editForm with current machine data
            this.editForm = {
                hostname: this.machine.hostname || '',
                memorable_name: this.machine.memorable_name || '',
                mac_address: this.machine.mac_address || '',
                ip_address: this.machine.ip_address || '',
                os_choice: this.machine.os_choice || ''
            };
            this.editFormError = ''; // Clear previous errors
            this.isEditing = true;
        },
        
        cancelEdit() {
            this.isEditing = false;
            this.editFormError = ''; // Clear errors on cancel
            // No need to reset editForm, startEditing will repopulate
        },
        
        saveChanges() {
            this.isSubmitting = true;
            this.editFormError = '';
            
            // Validate MAC address format
            if (this.editForm.mac_address && !/^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$/.test(this.editForm.mac_address)) {
                this.editFormError = 'Invalid MAC address format. Please use XX:XX:XX:XX:XX:XX format.';
                this.isSubmitting = false;
                return;
            }
            
            // Validate IP address format if provided
            if (this.editForm.ip_address && !/^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(this.editForm.ip_address)) {
                this.editFormError = 'Invalid IP address format. Must be a valid IPv4 address.';
                this.isSubmitting = false;
                return;
            }
            
            // Validate hostname format if provided
            if (this.editForm.hostname && !/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(this.editForm.hostname)) {
                this.editFormError = 'Invalid hostname format. Must follow RFC-1123 standard.';
                this.isSubmitting = false;
                return;
            }
            
            fetch(`/api/machines/${this.machine.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(this.editForm)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.message || 'Failed to update machine');
                    });
                }
                return response.json();
            })
            .then(data => {
                // Update the machine data directly in our model
                Object.assign(this.machine, this.editForm);
                
                // Show success toast
                if (window.showToast) {
                    window.showToast(`Machine updated successfully`, 'success');
                }
                
                // Exit editing mode
                this.isEditing = false; 
            })
            .catch(error => {
                this.editFormError = error.message || 'An error occurred while updating the machine';
                console.error('Error updating machine:', error);
                // Remain in editing mode on error
            })
            .finally(() => {
                this.isSubmitting = false;
            });
        },
        
        deleteMachine() {
            this.isDeleting = true;
            
            fetch(`/api/machines/${this.machine.id}`, {
                method: 'DELETE',
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || `HTTP error! status: ${response.status}`);
                    });
                }
                return response.text();
            })
            .then(() => {
                // Show success toast
                if (window.showToast) {
                    window.showToast(`Machine deleted successfully`, 'success');
                }
                
                // Redirect to machines list
                window.location.href = '/machines';
            })
            .catch(error => {
                if (window.showToast) {
                    window.showToast(`Failed to delete machine: ${error.message}`, 'error');
                }
                console.error('Error deleting machine:', error);
                this.deleteModalOpen = false;
            })
            .finally(() => {
                this.isDeleting = false;
            });
        },

        initSSE() {
            console.log("Initializing SSE connection...");
            if (this.evtSource && this.evtSource.readyState !== EventSource.CLOSED) {
                 console.log("SSE connection already open.");
                 return;
            }
            if (!this.machineId || this.machineId === 'error') {
                 console.warn("Cannot initialize SSE without a valid machine ID.");
                 return; // Don't init if ID not set or error
            }

            // Close existing connection if any (e.g., after error retry)
            if (this.evtSource) {
                this.evtSource.close();
            }

            console.log(`Attempting SSE connection to /api/events for machine ${this.machineId}`);
            this.evtSource = new EventSource('/api/events');
            window.globalEvtSource = this.evtSource; // Keep global reference if needed elsewhere

            this.evtSource.onopen = () => {
                console.log("SSE connection opened.");
                this.error = null; // Clear error on successful connection
            };

            this.evtSource.onerror = (err) => {
                console.error('Global SSE connection error:', err);
                // Removed sse.close() to allow auto-reconnect
                console.log('SSE connection error. Browser will attempt to reconnect automatically.');
                // Optionally set an error state for the UI
                this.error = "Connection lost. Attempting to reconnect..."; 
            };

            // Generic message handler (if needed)
            this.evtSource.onmessage = (event) => {
                 console.log("Generic SSE message received:", event.data);
            };

            // --- Listener Replacement Start ---
            // Listen for machine updates with debounced fetch fallback
            this.evtSource.addEventListener('machine_updated', (event) => {
                console.log('Received machine_updated event:', event.data);
                try {
                    const eventData = JSON.parse(event.data);
                    
                    // Clear any pending fetch timeout
                    clearTimeout(this.fetchDebounceTimer);

                    // Check if the event contains the full machine object
                    if (eventData.machine) {
                        // Full data received directly in the event
                        console.log('Processing full data from SSE event.');
                        // Ensure we only update if the ID matches the current machine
                        if (eventData.machine.id === this.machine.id) {
                            this.machine = eventData.machine;
                            this.workflow_info = eventData.workflow_info || null; 
                            console.log('Updated machine state from SSE event:', this.machine);
                            console.log('Updated workflow info from SSE event:', this.workflow_info);
                        } else {
                            console.warn('Received full machine_updated event for a different machine ID:', eventData.machine.id, 'Expected:', this.machine.id);
                        }
                    } else if (eventData.id === this.machine.id) {
                        // Only ID received, debounce the fetch for the current machine
                        console.log(`Debouncing fetch for machine ${eventData.id}...`);
                        this.fetchDebounceTimer = setTimeout(() => {
                            console.log(`Executing debounced fetch for machine ${eventData.id}`);
                            fetch(`/api/machines/${eventData.id}`)
                                .then(response => {
                                    if (!response.ok) {
                                        // Throw an error to be caught by .catch()
                                        throw new Error(`Network response was not ok: ${response.statusText} (${response.status})`);
                                    }
                                    return response.json();
                                })
                                .then(fullData => {
                                    console.log('Fetched full data after event:', fullData);
                                    if (fullData.machine && fullData.machine.id === this.machine.id) {
                                        this.machine = fullData.machine;
                                        this.workflow_info = fullData.workflow_info || null;
                                        console.log('Updated machine state via fetch:', this.machine);
                                        console.log('Updated workflow info via fetch:', this.workflow_info);
                                        this.error = null; // Clear fetch error on success
                                    } else if (fullData.machine && fullData.machine.id !== this.machine.id) {
                                        console.warn('Fetched data belongs to a different machine ID:', fullData.machine.id, 'Expected:', this.machine.id);
                                    } else {
                                        console.warn('Fetched data missing machine structure or ID mismatch:', fullData);
                                    }
                                })
                                .catch(error => {
                                    // Log the network error 
                                    console.error('Error fetching full machine data:', error);
                                    // Update UI error state
                                    this.error = `Failed to fetch update for ${eventData.id}: ${error.message}. Retrying on next event.`;
                                });
                        }, 32); // <-- Changed debounce delay from 500 to 32ms
                    } else {
                        // Event is for a different machine or has unexpected format
                        console.warn('Ignoring machine_updated event: ID mismatch or invalid format.', 'Event ID:', eventData.id, 'Current Machine ID:', this.machine.id);
                    }
                } catch (e) {
                    console.error('Error parsing machine_updated event data:', e, 'Raw data:', event.data);
                    // Potentially update UI error state if parsing fails critically
                    this.error = "Error processing update event.";
                }
            });
            // --- Listener Replacement End ---

            // Listen for machine discovered events
            this.evtSource.addEventListener('machine_discovered', (event) => {
                console.log("SSE Listener: machine_discovered received:", event.data);
                // Add parsing and update logic here
            });

            // Add other specific listeners (ip_download_progress, task_progress) here if needed
            this.evtSource.addEventListener('ip_download_progress', (event) => {
                console.log("[PROGRESS_LISTENER] Listener is active!");
                console.log("SSE Listener: ip_download_progress received:", event.data);
                try {
                    const progressData = JSON.parse(event.data);
                    // Update logic based on progressData...
                    // Example: Find relevant task and update its progress visually
                    if (progressData.machine_id === this.machineId) {
                         console.log("Matching machine ID for progress update.");
                         const taskName = progressData.file_name || 'stream image'; // Use lowercase default
                         const bytesDownloaded = progressData.bytes_downloaded;
                         const totalSize = progressData.total_size;
                         const calculatedProgress = (totalSize > 0) ? (bytesDownloaded / totalSize * 100) : 0;

                         // Update the reactive state. Alpine will handle the DOM update.
                         // Ensure the task exists in the state before updating
                         if (this.taskProgressState[taskName] !== undefined) {
                            // Direct assignment for Alpine 3 reactivity
                            this.taskProgressState[taskName] = {
                                percent: calculatedProgress,
                                bytesDownloaded: bytesDownloaded,
                                totalSize: totalSize
                            };
                            console.log(`Updated taskProgressState for ${taskName}:`, JSON.stringify(this.taskProgressState[taskName]));
                         } else {
                            // Log if the task name from the event doesn't match any known task
                            console.warn(`Task state key not found for progress update: ${taskName}`);
                         }
                     }
                } catch (e) {
                     console.error('Error processing ip_download_progress event:', e, event.data);
                }
            });

             // Example for task_progress (adjust format if needed)
             this.evtSource.addEventListener('task_progress', (event) => {
                 console.log("SSE Listener: task_progress received:", event.data);
                 // Add parsing and update logic here
             });

        },

        initializeComponent() {
            console.log("Initializing Machine Details Component");

            // Check if JSON data is available
            const machineDataElement = document.getElementById('machine-data-json');
            const workflowDataElement = document.getElementById('workflow-data-json');

            if (machineDataElement && machineDataElement.textContent) {
                try {
                    this.machine = JSON.parse(machineDataElement.textContent);
                    console.log("Machine data loaded from JSON:", this.machine);
                    
                    // Explicitly set the machineId from the machine data
                    this.machineId = this.machine.id;
                    this.machineIp = this.machine.ip_address;
                    console.log("Machine ID set to:", this.machineId);
                    
                    // Set IP Address Type from template variable
                    this.ipAddressType = '{{ ip_address_type | safe }}';
                    console.log("IP Address Type:", this.ipAddressType);
                    
                    this.editForm = { ...this.machine }; // Initialize edit form
                } catch (e) {
                    console.error("Failed to parse machine JSON:", e);
                    // Set default error state
                    this.machine = { id: 'error', ip_address: 'error', status: 'Error parsing data', hostname: 'Error' };
                    this.workflow_info = null;
                    this.machineId = 'error';
                    this.machineIp = 'error';
                }
            } else {
                console.error("Machine data not found in script tag.");
                // Set default error state
                this.machine = { id: 'error', ip_address: 'error', status: 'Error parsing data', hostname: 'Error' };
                this.workflow_info = null;
                this.machineId = 'error';
                this.machineIp = 'error';
            }

            // Parse workflow info if available
            if (workflowDataElement && workflowDataElement.textContent) {
                try {
                    this.workflow_info = JSON.parse(workflowDataElement.textContent);
                    console.log("Workflow info loaded from JSON:", this.workflow_info);
                } catch (e) {
                    console.error("Failed to parse workflow JSON:", e);
                    this.workflow_info = null;
                }
            }

            // Initialize task progress state from DOM after initial render
            this.$nextTick(() => {
                if (this.workflow_info && this.workflow_info.tasks) {
                    this.workflow_info.tasks.forEach(task => {
                        // Initialize with the structure expected by the template
                        if (this.taskProgressState[task.name] === undefined) { // Avoid overwriting if already updated by SSE
                            this.taskProgressState[task.name] = { 
                                percent: task.progress || 0,
                                bytesDownloaded: 0, // Assume 0 initially
                                totalSize: 0 // Assume 0 initially, update via SSE
                            };
                        }
                    });
                    console.log("Initial taskProgressState:", JSON.stringify(this.taskProgressState));
                }
            });

            // Initialize SSE connection AFTER initial data is parsed and properties are set
            this.initSSE(); 
        },

        // Helper function to format progress text
        generateProgressText(progressInfo) {
            if (!progressInfo) {
                return '0%'; // Or 'Pending' or whatever default
            }
            const percent = progressInfo.percent || 0;
            if (progressInfo.totalSize > 0) {
                const downloadedMB = (progressInfo.bytesDownloaded / (1024 * 1024)).toFixed(1);
                const totalMB = (progressInfo.totalSize / (1024 * 1024)).toFixed(1);
                return `${percent.toFixed(1)}% (${downloadedMB}/${totalMB} MB)`;
            } else {
                return `${percent.toFixed(1)}%`;
            }
        },

        fetchMachineData() {
            if (!this.machineId) return;
            // ... existing code ...
            this.evtSource.addEventListener('ip_download_progress', (event) => {
                console.log("[PROGRESS_LISTENER] Listener is active!"); // Added listener active log
                console.log("SSE Listener: ip_download_progress received:", event.data);
                try {
                    const progressData = JSON.parse(event.data);
                    // Update logic based on progressData...
                    // Example: Find relevant task and update its progress visually
                    if (progressData.machine_id === this.machineId) {
                         console.log("Matching machine ID for progress update.");
                         const taskName = progressData.file_name || 'stream image'; // Use lowercase default
                         const bytesDownloaded = progressData.bytes_downloaded;
                         const totalSize = progressData.total_size;
                         const calculatedProgress = (totalSize > 0) ? (bytesDownloaded / totalSize * 100) : 0;

                         // Update the reactive state. Alpine will handle the DOM update.
                         // Ensure the task exists in the state before updating
                         if (this.taskProgressState[taskName] !== undefined) {
                            // Direct assignment for Alpine 3 reactivity
                            this.taskProgressState[taskName] = {
                                percent: calculatedProgress,
                                bytesDownloaded: bytesDownloaded,
                                totalSize: totalSize
                            };
                            console.log(`Updated taskProgressState for ${taskName}:`, JSON.stringify(this.taskProgressState[taskName]));
                         } else {
                            // Log if the task name from the event doesn't match any known task
                            console.warn(`Task state key not found for progress update: ${taskName}`);
                         }
                     }
                } catch (e) {
                     console.error('Error processing ip_download_progress event:', e, event.data);
                }
            });

             // Example for task_progress (adjust format if needed)
             this.evtSource.addEventListener('task_progress', (event) => {
                 console.log("SSE Listener: task_progress received:", event.data);
                 // Add parsing and update logic here
             });

        }
    };
  }

  document.addEventListener('DOMContentLoaded', () => {
    console.log("Machine details page loaded, Alpine component should initialize shortly.");
  });
</script>
{% endblock %}