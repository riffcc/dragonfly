{% extends "base.html" %}

{% block head %}
<!-- Lucide icons -->
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
{% endblock %}

{% block content %}

<div x-data="machineDetailsData()"
    x-init="initializeComponent()">

    {# Embed JSON data using script tags #}
    <script id="machine-data-json" type="application/json">
        {{ machine_json | safe }} {# Use safe within script tag #}
    </script>
    <script id="workflow-data-json" type="application/json">
        {{ workflow_info_json | safe }} {# Use safe within script tag #}
    </script>

    {# ===== LAYOUT: SIDEBAR + CONTENT ===== #}
    <div class="flex gap-6 max-w-[1400px] mx-auto">

    {# Sidebar nav #}
    <aside class="hidden lg:flex flex-col gap-1 w-[200px] shrink-0 pt-2">
        <a href="#" class="flex items-center gap-3 px-4 py-3 rounded-lg text-sm bg-purple-600 text-white font-medium">
            <span class="w-5 text-center">üìã</span> Overview
        </a>
        <span class="flex items-center gap-3 px-4 py-3 rounded-lg text-sm text-gray-400 dark:text-gray-500 cursor-default opacity-50">
            <span class="w-5 text-center">üìä</span> Metrics
        </span>
        <span class="flex items-center gap-3 px-4 py-3 rounded-lg text-sm text-gray-400 dark:text-gray-500 cursor-default opacity-50">
            <span class="w-5 text-center">üìú</span> Logs
        </span>
        <span class="flex items-center gap-3 px-4 py-3 rounded-lg text-sm text-gray-400 dark:text-gray-500 cursor-default opacity-50">
            <span class="w-5 text-center">üîß</span> Console
        </span>
        <span class="flex items-center gap-3 px-4 py-3 rounded-lg text-sm text-gray-400 dark:text-gray-500 cursor-default opacity-50">
            <span class="w-5 text-center">üì∏</span> Snapshots
        </span>
        <span class="flex items-center gap-3 px-4 py-3 rounded-lg text-sm text-gray-400 dark:text-gray-500 cursor-default opacity-50">
            <span class="w-5 text-center">‚è±Ô∏è</span> History
        </span>
    </aside>

    {# Main content #}
    <div class="flex-1 min-w-0">

    {# ===== PAGE HEADER ===== #}
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
        <div class="flex items-center gap-4">
            {# Click-to-edit hostname in header #}
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
                <span x-show="editingField !== 'hostname'"
                    {% if is_authenticated %}@click="startFieldEdit('hostname', machine.hostname || '')"{% endif %}
                    class="{% if is_authenticated %}cursor-pointer hover:bg-purple-50 dark:hover:bg-purple-900/10 rounded px-1 -mx-1{% endif %} transition-colors"
                    x-text="machine.hostname || 'No hostname set'"></span>
                <input x-show="editingField === 'hostname'" x-cloak
                    x-ref="edit_hostname"
                    :value="editValue"
                    @input="editValue = $event.target.value"
                    @keydown.enter="commitField('hostname')"
                    @keydown.escape="cancelFieldEdit()"
                    @blur="editingField === 'hostname' && commitField('hostname')"
                    class="text-3xl font-bold bg-transparent border-b-2 border-purple-500 outline-none text-gray-900 dark:text-white"
                    style="field-sizing: content"
                    placeholder="hostname" spellcheck="false" autocomplete="off">
            </h1>
            {# Static badge for non-installing states #}
            <span x-show="machine.status !== 'Installing'" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold"
                :class="{
                    'bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-300': machine.status === 'Ready' || machine.status === 'Installed',
                    'bg-red-100 text-red-800 dark:bg-red-900/40 dark:text-red-300': machine.status === 'Failed',
                    'bg-blue-100 text-blue-800 dark:bg-blue-900/40 dark:text-blue-300': machine.status === 'Discovered' || machine.status === 'ReadyToInstall',
                    'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300': machine.status === 'Offline' || machine.status === 'ExistingOs',
                    'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/40 dark:text-yellow-300': machine.status === 'Initializing' || machine.status === 'Writing',
                    'bg-purple-100 text-purple-800 dark:bg-purple-900/40 dark:text-purple-300': !['Ready','Installed','Installing','Initializing','Writing','Failed','Discovered','ReadyToInstall','Offline','ExistingOs'].includes(machine.status)
                }"
                x-text="formatStatus(machine.status)">
            </span>
            {# Live progress badge for Installing #}
            <div x-show="machine.status === 'Installing'" x-cloak class="inline-flex items-center gap-2">
                <div class="flex items-center gap-2 px-3 py-1 rounded-full bg-yellow-900/40 text-yellow-300 text-xs font-semibold">
                    <svg class="animate-spin h-3 w-3 text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <span x-text="'Installing ' + liveProgress.percent + '%'"></span>
                </div>
                <div class="w-32 h-2 rounded-full bg-yellow-700/30 overflow-hidden">
                    <div class="h-full bg-yellow-500 rounded-full transition-all duration-300"
                        :style="'width: ' + liveProgress.percent + '%'"></div>
                </div>
                <span x-show="liveProgress.action" class="text-xs text-gray-400" x-text="liveProgress.action"></span>
            </div>
        </div>
    </div>

    {# ===== ACTIONS ROW ‚Äî machine actions (left) + config actions (right) ===== #}
    <div class="flex flex-wrap items-center gap-2 mb-6">
        <button @click="powerAction('reboot')" :disabled="actionInProgress"
            class="inline-flex items-center gap-1.5 px-3 py-2 bg-transparent border-[1.5px] border-blue-600 dark:border-blue-500 rounded-lg text-xs text-blue-700 dark:text-blue-400 hover:bg-blue-500/10 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
            <svg x-show="actionInProgress === 'reboot'" x-cloak class="animate-spin w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <i x-show="actionInProgress !== 'reboot'" data-lucide="refresh-cw" class="w-3.5 h-3.5"></i> Reboot
        </button>
        <button @click="powerAction('start')" :disabled="actionInProgress"
            class="inline-flex items-center gap-1.5 px-3 py-2 bg-transparent border-[1.5px] border-green-600 dark:border-green-500 rounded-lg text-xs text-green-700 dark:text-green-400 hover:bg-green-500/10 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
            <svg x-show="actionInProgress === 'start'" x-cloak class="animate-spin w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <i x-show="actionInProgress !== 'start'" data-lucide="power" class="w-3.5 h-3.5"></i> Power On
        </button>
        <button @click="powerAction('shutdown')" :disabled="actionInProgress"
            class="inline-flex items-center gap-1.5 px-3 py-2 bg-transparent border-[1.5px] border-yellow-600 dark:border-yellow-500 rounded-lg text-xs text-yellow-700 dark:text-yellow-400 hover:bg-yellow-500/10 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
            <svg x-show="actionInProgress === 'shutdown'" x-cloak class="animate-spin w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <i x-show="actionInProgress !== 'shutdown'" data-lucide="circle-stop" class="w-3.5 h-3.5"></i> Shutdown
        </button>
        <button @click="powerAction('stop')" :disabled="actionInProgress"
            class="inline-flex items-center gap-1.5 px-3 py-2 bg-transparent border-[1.5px] border-orange-600 dark:border-orange-500 rounded-lg text-xs text-orange-700 dark:text-orange-400 hover:bg-orange-500/10 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
            <svg x-show="actionInProgress === 'stop'" x-cloak class="animate-spin w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <i x-show="actionInProgress !== 'stop'" data-lucide="power-off" class="w-3.5 h-3.5"></i> Power Off
        </button>
        <button @click="evacuateModal = true" :disabled="actionInProgress"
            class="inline-flex items-center gap-1.5 px-3 py-2 bg-transparent border-0 rounded-lg text-xs text-yellow-700 dark:text-yellow-400 hover:bg-yellow-500/10 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" style="outline: 2px dashed; outline-offset: -2px;">
            <i data-lucide="life-buoy" class="w-3.5 h-3.5"></i> Evacuate
        </button>
        <button @click="reimageAction()" :disabled="actionInProgress"
            class="inline-flex items-center gap-1.5 px-3 py-2 bg-transparent border-0 rounded-lg text-xs text-red-700 dark:text-red-400 hover:bg-red-500/10 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" style="outline: 2px dashed; outline-offset: -2px;">
            <svg x-show="actionInProgress === 'reimage'" x-cloak class="animate-spin w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <i x-show="actionInProgress !== 'reimage'" data-lucide="eraser" class="w-3.5 h-3.5"></i> Reimage
        </button>

        <div class="flex-1"></div>

        {% if is_authenticated %}
        {# Apply ‚Äî shown when config is saved to DB but not yet pushed to host, AND no new local edits #}
        <button x-show="machine.pending_apply && !hasPendingChanges()" x-cloak
            @click="applyConfig()"
            class="inline-flex items-center gap-1.5 px-3 py-2 bg-blue-800 hover:bg-blue-900 border-[1.5px] border-blue-700 shadow-inner rounded-lg text-xs text-white font-semibold transition-colors">
            Apply
        </button>
        {# Save/Cancel ‚Äî shown when there are unsaved local changes (hides Apply) #}
        <button x-show="hasPendingChanges()" x-cloak
            @click="saveAllChanges()" :disabled="isSubmitting"
            class="inline-flex items-center gap-1.5 px-3 py-2 bg-transparent border-[1.5px] border-green-600 dark:border-green-500 rounded-lg text-xs text-green-700 dark:text-green-400 hover:bg-green-500/10 font-medium transition-colors disabled:opacity-50">
            <span x-show="isSubmitting" class="inline-flex items-center"><svg class="animate-spin -ml-0.5 mr-1 h-3 w-3 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Saving</span>
            <span x-show="!isSubmitting">Save</span>
        </button>
        <button x-show="hasPendingChanges()" x-cloak
            @click="cancelAllChanges()"
            class="inline-flex items-center gap-1.5 px-3 py-2 bg-transparent border-[1.5px] border-blue-700 dark:border-blue-600 hover:bg-blue-800/10 rounded-lg text-xs text-blue-800 dark:text-blue-400 font-medium transition-colors">
            Cancel
        </button>
        <span x-show="editFormError" x-cloak class="text-xs text-red-500" x-text="editFormError"></span>
        <button @click="deleteModalOpen = true"
            class="inline-flex items-center gap-1.5 px-3 py-2 bg-transparent border-[1.5px] border-red-600 dark:border-red-700 hover:bg-red-600/10 rounded-lg text-xs text-red-600 dark:text-red-400 font-medium transition-colors">
            Delete
        </button>
        {% endif %}
        <a href="/machines" class="inline-flex items-center gap-1.5 px-3 py-2 bg-transparent border-[1.5px] border-purple-600 dark:border-purple-500 hover:bg-purple-500/10 rounded-lg text-xs text-purple-700 dark:text-purple-400 font-medium transition-colors">
            <i data-lucide="arrow-big-left" class="w-3.5 h-3.5"></i> Machines
        </a>
    </div>

    {# ===== INFO GRID (4-column: Hostname+IP, Status, Uptime, Created) ===== #}
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="flex flex-col gap-1">
            <span class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider font-medium">Hostname <span x-show="isFieldPending('hostname')" x-cloak class="text-green-500 dark:text-green-400 normal-case tracking-normal font-normal">(Pending)</span><span x-show="isFieldSavedPending('hostname')" x-cloak class="text-yellow-500 dark:text-yellow-400 normal-case tracking-normal font-normal">(Pending)</span></span>
            <span class="text-sm">
                <span x-show="editingField !== 'hostname_grid'"
                    {% if is_authenticated %}@click="startFieldEdit('hostname_grid', machine.hostname || '')"{% endif %}
                    class="text-purple-600 dark:text-purple-400 {% if is_authenticated %}cursor-pointer hover:underline{% endif %}"
                    x-text="(machine.hostname || machine.reported_hostname || 'Not set')"></span>
                <input x-show="editingField === 'hostname_grid'" x-cloak
                    x-ref="edit_hostname_grid"
                    :value="editValue"
                    @input="editValue = $event.target.value"
                    @keydown.enter="commitField('hostname')"
                    @keydown.escape="cancelFieldEdit()"
                    @blur="editingField === 'hostname_grid' && commitField('hostname')"
                    class="text-sm bg-transparent border-b-2 border-purple-500 outline-none text-purple-600 dark:text-purple-400"
                    style="field-sizing: content"
                    placeholder="hostname" spellcheck="false" autocomplete="off">
                {# IP address ‚Äî click to edit #}
                <span x-show="editingField !== 'ip_address'" class="text-gray-500 dark:text-gray-500 tech-mono text-xs ml-1">
                    <span {% if is_authenticated %}@click="startFieldEdit('ip_address', machine.ip_address || '')"{% endif %}
                        class="{% if is_authenticated %}cursor-pointer hover:underline{% endif %}"
                        x-text="machine.ip_address ? '(' + machine.ip_address + ')' : ''"></span>
                </span>
                <input x-show="editingField === 'ip_address'" x-cloak
                    x-ref="edit_ip_address"
                    :value="editValue"
                    @input="editValue = $event.target.value"
                    @keydown.enter="commitField('ip_address')"
                    @keydown.escape="cancelFieldEdit()"
                    @blur="editingField === 'ip_address' && commitField('ip_address')"
                    class="text-xs tech-mono bg-transparent border-b border-purple-500 outline-none text-gray-700 dark:text-gray-300 ml-1"
                    style="field-sizing: content"
                    placeholder="IP address" spellcheck="false" autocomplete="off">
            </span>
        </div>
        <div class="flex flex-col gap-1">
            <span class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider font-medium">Status</span>
            {# Normal status text for non-installing states #}
            <span x-show="machine.status !== 'Installing'" class="text-sm"
                :class="{
                    'text-green-600 dark:text-green-400': machine.status === 'Ready' || machine.status === 'Installed',
                    'text-yellow-600 dark:text-yellow-400': machine.status === 'Initializing' || machine.status === 'Writing',
                    'text-red-600 dark:text-red-400': machine.status === 'Failed',
                    'text-blue-600 dark:text-blue-400': machine.status === 'Discovered' || machine.status === 'ReadyToInstall',
                    'text-gray-600 dark:text-gray-400': !['Ready','Installed','Installing','Initializing','Writing','Failed','Discovered','ReadyToInstall'].includes(machine.status)
                }"
                x-text="formatStatus(machine.status)"></span>
            {# Live progress for Installing #}
            <div x-show="machine.status === 'Installing'" x-cloak class="flex flex-col gap-1">
                <span class="text-sm text-yellow-600 dark:text-yellow-400 font-medium" x-text="'Installing ' + liveProgress.percent + '%'"></span>
                <span x-show="liveProgress.message" class="text-xs text-gray-500 dark:text-gray-500 truncate max-w-[200px]" x-text="liveProgress.message"></span>
            </div>
        </div>
        <div class="flex flex-col gap-1">
            <span class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider font-medium">Uptime</span>
            <span class="text-sm text-gray-900 dark:text-gray-200" x-text="machine.uptime || 'Unknown'"></span>
        </div>
        <div class="flex flex-col gap-1">
            <span class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider font-medium">Created</span>
            <span class="text-sm text-gray-900 dark:text-gray-200" x-text="'{{ created_at_formatted }}'"></span>
        </div>
    </div>

    {# ===== TAGS (inline) ===== #}
    <div class="flex flex-wrap gap-2 mb-6">
        <template x-if="machine.tags && machine.tags.length > 0">
            <template x-for="tag in machine.tags" :key="tag.id || tag.name">
                <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-gray-100 dark:bg-[#1a1a1a] border border-gray-200 dark:border-[#333] rounded-full text-sm text-gray-700 dark:text-gray-300">
                    <span x-show="tag.emoji" x-text="tag.emoji" class="text-sm"></span>
                    <span x-text="tag.name"></span>
                    {% if is_authenticated %}
                    <button @click="removeTag(tag)" class="text-gray-400 hover:text-red-500 ml-0.5 transition-colors">&times;</button>
                    {% endif %}
                </span>
            </template>
        </template>
        {% if is_authenticated %}
        <button @click="addTagModal = true"
            class="inline-flex items-center gap-1 px-3 py-1.5 bg-transparent border border-dashed border-gray-300 dark:border-[#444] rounded-full text-sm text-gray-500 dark:text-gray-500 hover:border-purple-500 hover:text-purple-500 dark:hover:border-purple-400 dark:hover:text-purple-400 transition-colors">
            + Tags
        </button>
        {% endif %}
    </div>

    {# ===== DEPLOYMENT PROGRESS (conditional) ===== #}
    <template x-if="machine.status === 'Installing'">
        <template x-if="workflow_info">
            <div class="rounded-xl border-2 border-purple-600 dark:border-purple-600 bg-white dark:bg-[#111] p-5 mb-6"
                 id="workflow-progress-container">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-yellow-100">Deployment Progress</h3>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-300">
                        Template: <span class="font-semibold" x-text="workflow_info.template_name"></span>
                            <template x-if="workflow_info.current_action"> &bull; Current action: <span x-text="workflow_info.current_action"></span></template>
                            <template x-if="workflow_info.current_action == 'Completed via kexec detection'">
                            <span class="ml-2 italic">(Auto-detected successful deployment)</span>
                        </template>
                    </p>
                </div>

                <div class="relative pt-1">
                    <div class="flex mb-2 items-center justify-between">
                            <div>
                            <span id="workflow-state-badge" class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full"
                                    :class="{
                                    'text-red-600 bg-red-200 dark:text-red-200 dark:bg-red-800/30': workflow_info.state === 'STATE_FAILED',
                                    'text-yellow-600 bg-yellow-200 dark:text-yellow-200 dark:bg-yellow-800/30': workflow_info.state !== 'STATE_FAILED'
                                    }">
                                    <span x-text="workflow_info.state === 'STATE_FAILED' ? 'Failed' : 'In Progress'"></span>
                            </span>
                        </div>
                            <div class="text-right">
                            <span id="workflow-progress-percent-text" class="text-xs font-semibold inline-block text-yellow-600 dark:text-yellow-200 workflow-progress-percent"
                                    x-text="workflow_info.progress + '% Complete'">
                            </span>
                        </div>
                    </div>
                    <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-yellow-200 dark:bg-yellow-700/30">
                        <div
                            id="workflow-progress-bar"
                            class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center workflow-overall-progress"
                            :class="workflow_info.state === 'STATE_FAILED' ? 'bg-red-500 dark:bg-red-600' : 'bg-yellow-500 dark:bg-yellow-600'"
                            :style="'width: ' + (workflow_info.progress || 0) + '%;'"
                            :data-progress="workflow_info.progress || 0">
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <h4 class="text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">Task Timeline</h4>
                    <div id="tasks-table-container" class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Action</th>
                                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Started At</th>
                                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Duration</th>
                                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Est. Duration</th>
                                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="tasks-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                    <template x-for="task in workflow_info.tasks" :key="task.name">
                                        <tr :data-task-name="task.name"
                                            :data-task-status="task.status"
                                            :data-started-at="task.started_at"
                                            :data-estimated-duration="task.estimated_duration">
                                            <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white" x-text="task.name"></td>
                                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400" x-text="task.started_at || 'N/A'"></td>
                                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                                <template x-if="task.status === 'STATE_SUCCESS'">
                                                    <span x-text="task.reported_duration + 's'"></span>
                                                </template>
                                                <template x-if="task.status === 'STATE_RUNNING'">
                                                    <div class="relative w-32">
                                                        <div class="overflow-hidden h-2 text-xs flex rounded bg-blue-200 dark:bg-blue-700/30">
                                                            <div class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-blue-500 dark:bg-blue-600 task-progress-bar"
                                                                :style="'width: ' + (taskProgressState[task.name]?.percent || 0) + '%;'"
                                                                :data-progress="taskProgressState[task.name]?.percent || 0">
                                                            </div>
                                                        </div>
                                                        <div class="text-xs mt-1 progress-text" x-text="generateProgressText(taskProgressState[task.name])"></div>
                                                    </div>
                                                </template>
                                                <template x-if="task.status !== 'STATE_SUCCESS' && task.status !== 'STATE_RUNNING'">
                                                    <span>Pending</span>
                                                </template>
                                            </td>
                                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                                <template x-if="task.estimated_duration !== null && task.estimated_duration !== undefined">
                                                    <span x-text="task.estimated_duration + 's'"></span>
                                                </template>
                                                <template x-if="task.estimated_duration === null || task.estimated_duration === undefined">
                                                    <span>N/A</span>
                                                </template>

                                                <template x-if="task.status === 'STATE_SUCCESS' &&
                                                        task.estimated_duration !== null && task.estimated_duration !== undefined &&
                                                        task.reported_duration !== null && task.reported_duration !== undefined &&
                                                        task.reported_duration !== task.estimated_duration">
                                                    <template x-if="task.reported_duration > task.estimated_duration">
                                                        <span class="text-red-500 ml-1" x-text="'(+' + (task.reported_duration - task.estimated_duration) + 's)'"></span>
                                                    </template>
                                                    <template x-if="task.reported_duration < task.estimated_duration">
                                                        <span class="text-green-500 ml-1" x-text="'(-' + (task.estimated_duration - task.reported_duration) + 's)'"></span>
                                                    </template>
                                                </template>
                                            </td>
                                        <td class="px-3 py-2 whitespace-nowrap text-sm">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                                    :class="{
                                                        'bg-green-100 text-green-800 dark:bg-green-400/10 dark:text-green-300': task.status === 'STATE_SUCCESS',
                                                        'bg-red-100 text-red-800 dark:bg-red-400/10 dark:text-red-300': task.status === 'STATE_FAILED',
                                                        'bg-yellow-100 text-yellow-800 dark:bg-yellow-400/10 dark:text-yellow-300': task.status === 'STATE_RUNNING',
                                                        'bg-gray-100 text-gray-800 dark:bg-gray-400/10 dark:text-gray-300': !['STATE_SUCCESS', 'STATE_FAILED', 'STATE_RUNNING'].includes(task.status)
                                                    }">
                                                <span x-text="task.status"></span>
                                            </span>
                                        </td>
                                    </tr>
                                    </template>
                            </tbody>
                        </table>
                    </div>

                    <template x-if="workflow_info && workflow_info.estimated_completion !== null && workflow_info.estimated_completion !== undefined">
                        <div class="mt-4 text-sm text-gray-600 dark:text-gray-300">
                            <p>Estimated completion: <span x-text="workflow_info.estimated_completion"></span></p>
                        </div>
                    </template>
                </div>
            </div>
        </template>
        <template x-if="!workflow_info">
            <div class="rounded-xl border border-gray-200 dark:border-[#1a1a1a] bg-white dark:bg-[#111] p-5 mb-6">
                <p class="text-sm text-gray-500 dark:text-gray-400 italic">Waiting for workflow information...</p>
            </div>
        </template>
    </template>

    {# ===== TWO-COLUMN: INFO + NETWORK ===== #}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
        {# Info Section #}
        <div class="rounded-xl border border-gray-200 dark:border-[#1a1a1a] bg-white dark:bg-[#111] p-5">
            <div class="mb-4">
                <h2 class="text-sm font-semibold text-gray-500 dark:text-gray-500 uppercase tracking-wider">Info</h2>
            </div>
            <div class="grid grid-cols-2 gap-x-6 gap-y-5">
                <div class="flex flex-col gap-1 relative">
                    <span class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider font-medium">Operating System <span x-show="isFieldPending('os_choice')" x-cloak class="text-green-500 dark:text-green-400 normal-case tracking-normal font-normal">(Pending)</span></span>
                    <span x-show="editingField !== 'os_choice'"
                        class="text-base font-semibold {% if is_authenticated %}cursor-pointer hover:underline{% endif %}"
                        :class="(machine.os_installed || machine.os_choice) ? 'text-gray-900 dark:text-gray-100' : 'text-purple-500 dark:text-purple-400'"
                        {% if is_authenticated %}@click="editingField === 'os_choice' ? cancelFieldEdit() : startFieldEdit('os_choice', machine.os_choice || machine.os_installed || '')"{% endif %}
                        x-text="osNames[machine.os_choice] || osNames[machine.os_installed] || machine.os_installed || machine.os_choice || '+ Set OS'"></span>
                    {% if is_authenticated %}
                    <div x-show="editingField === 'os_choice'" x-cloak
                        @keydown.escape.window="editingField === 'os_choice' && cancelFieldEdit()"
                        @click.outside="editingField === 'os_choice' && cancelFieldEdit()"
                        class="absolute top-full left-0 mt-1 z-20 min-w-[220px] max-h-[300px] overflow-y-auto rounded-lg border border-gray-200 dark:border-[#333] bg-white dark:bg-[#1a1a1a] shadow-lg py-1">
                        <template x-for="tpl in templates.filter(t => t.enabled !== false)" :key="tpl.name">
                            <button type="button"
                                @click="commitDropdown('os_choice', tpl.name)"
                                class="w-full text-left px-3 py-1.5 text-sm transition-colors"
                                :class="(machine.os_choice || machine.os_installed) === tpl.name
                                    ? 'text-purple-600 dark:text-purple-400 font-medium bg-purple-50 dark:bg-purple-900/20'
                                    : 'text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-[#222]'"
                                x-text="osNames[tpl.name] || tpl.name"></button>
                        </template>
                        <template x-if="templates.filter(t => t.enabled !== false).length === 0">
                            <span class="block px-3 py-1.5 text-sm text-gray-400 italic">No templates available</span>
                        </template>
                    </div>
                    {% endif %}
                </div>
                <div class="flex flex-col gap-1">
                    <span class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider font-medium flex items-center gap-2">
                        CPU
                        <template x-if="machine.cpu_cores">
                            <span class="inline-flex items-center gap-0.5 text-gray-400 dark:text-gray-500 normal-case tracking-normal">
                                <i data-lucide="cpu" class="w-3 h-3"></i>
                                {# Editable cores for Proxmox VMs #}
                                <span x-show="editingField !== 'cpu_cores'"
                                    {% if is_authenticated %}@click="machine.proxmox_vmid ? startFieldEdit('cpu_cores', String(machine.cpu_cores || '')) : null"{% endif %}
                                    :class="machine.proxmox_vmid ? 'cursor-pointer hover:underline' : ''"
                                    x-text="machine.cpu_cores"></span>
                                <input x-show="editingField === 'cpu_cores'" x-cloak
                                    x-ref="edit_cpu_cores" type="number" min="1" max="512"
                                    :value="editValue" @input="editValue = $event.target.value"
                                    @keydown.enter="commitCpuCores()"
                                    @keydown.escape="cancelFieldEdit()"
                                    @blur="editingField === 'cpu_cores' && commitCpuCores()"
                                    class="text-xs bg-transparent border-b-2 border-purple-500 outline-none text-gray-700 dark:text-gray-300 w-10">
                                <span x-show="isFieldPending('cpu_cores')" x-cloak class="text-green-500 dark:text-green-400 text-[10px]">*</span>
                            </span>
                        </template>
                        <template x-if="machine.cpu_threads && machine.cpu_threads !== machine.cpu_cores">
                            <span class="inline-flex items-center gap-0.5 text-gray-400 dark:text-gray-500 normal-case tracking-normal">
                                <i data-lucide="spool" class="w-3 h-3"></i>
                                <span x-text="machine.cpu_threads"></span>
                            </span>
                        </template>
                    </span>
                    <span class="text-base font-semibold text-gray-900 dark:text-gray-100" x-text="machine.cpu_model || 'Unknown'"></span>
                </div>
                <div class="flex flex-col gap-1">
                    <span class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider font-medium">Memory <span x-show="isFieldPending('total_ram_bytes')" x-cloak class="text-green-500 dark:text-green-400 normal-case tracking-normal font-normal">(Pending)</span></span>
                    <span x-show="editingField !== 'ram_gib'"
                        class="text-base font-semibold text-gray-900 dark:text-gray-100"
                        {% if is_authenticated %}@click="machine.proxmox_vmid ? startFieldEdit('ram_gib', String(machine.total_ram_bytes ? Math.round(machine.total_ram_bytes / (1024*1024*1024)) : '')) : null"{% endif %}
                        :class="machine.proxmox_vmid ? 'cursor-pointer hover:underline' : ''"
                        x-text="machine.total_ram_bytes ? formatBytes(machine.total_ram_bytes) : 'Unknown'"></span>
                    <div x-show="editingField === 'ram_gib'" x-cloak class="flex items-center gap-1">
                        <input x-ref="edit_ram_gib" type="number" min="0.5" step="0.5"
                            :value="editValue" @input="editValue = $event.target.value"
                            @keydown.enter="commitRamGib()"
                            @keydown.escape="cancelFieldEdit()"
                            @blur="editingField === 'ram_gib' && commitRamGib()"
                            class="text-base font-semibold bg-transparent border-b-2 border-purple-500 outline-none text-gray-900 dark:text-gray-100 w-16">
                        <span class="text-xs text-gray-400">GiB</span>
                    </div>
                </div>
                <template x-if="machine.gpus && machine.gpus.length > 0">
                    <div class="flex flex-col gap-1">
                        <span class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider font-medium">GPU</span>
                        <span class="text-base font-semibold text-gray-900 dark:text-gray-100" x-text="machine.gpus[0].name"></span>
                    </div>
                </template>
                <template x-if="machine.bmc_credentials">
                    <div class="flex flex-col gap-1">
                        <span class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider font-medium">BMC State</span>
                        <span class="text-sm text-green-600 dark:text-green-400 font-medium">
                            <span x-text="machine.bmc_credentials.address || 'Configured'"></span>
                            <template x-if="machine.bmc_credentials.bmc_type">
                                <span class="text-gray-400 dark:text-gray-500 ml-1 font-normal" x-text="'(' + machine.bmc_credentials.bmc_type + ')'"></span>
                            </template>
                        </span>
                    </div>
                </template>
            </div>
        </div>

        {# Network Section ‚Äî per-field click-to-edit, no bulk edit mode #}
        <div class="rounded-xl border border-gray-200 dark:border-[#1a1a1a] bg-white dark:bg-[#111] p-5">
            <div class="mb-4 flex items-center justify-between">
                <h2 class="text-sm font-semibold text-gray-500 dark:text-gray-500 uppercase tracking-wider">Networking</h2>
                {% if is_authenticated %}
                <template x-if="machine.pending_apply && !hasPendingChanges()">
                    <button @click="revertPendingChanges()" class="text-xs px-2 py-0.5 rounded-full border border-blue-500 dark:border-blue-400 text-blue-600 dark:text-blue-400 hover:bg-blue-500/10 font-medium transition-colors">Revert changes</button>
                </template>
                {% endif %}
            </div>
            <div class="grid grid-cols-2 gap-x-6 gap-y-4">
                {# Domain ‚Äî simple click-to-edit text field #}
                <div class="flex flex-col gap-1 items-start">
                    <span class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider font-medium">Domain <span x-show="isFieldPending('domain')" x-cloak class="text-green-500 dark:text-green-400 normal-case tracking-normal font-normal">(Pending)</span><span x-show="isFieldSavedPending('domain')" x-cloak class="text-yellow-500 dark:text-yellow-400 normal-case tracking-normal font-normal">(Pending)</span></span>
                    <span x-show="editingField !== 'domain'"
                        class="text-sm {% if is_authenticated %}cursor-pointer hover:underline{% endif %}"
                        :class="machine.domain ? 'text-gray-700 dark:text-gray-300' : 'text-purple-500 dark:text-purple-400'"
                        {% if is_authenticated %}@click="startFieldEdit('domain', machine.domain || '')"{% endif %}
                        x-text="machine.domain || '+ Add'"></span>
                    {% if is_authenticated %}
                    <input x-show="editingField === 'domain'" x-cloak
                        x-ref="edit_domain"
                        :value="editValue" @input="editValue = $event.target.value"
                        @keydown.enter="commitField('domain')"
                        @keydown.escape="cancelFieldEdit()"
                        @blur="editingField === 'domain' && commitField('domain')"
                        class="text-sm bg-transparent border-b-2 border-purple-500 outline-none text-gray-700 dark:text-gray-300 px-0"
                        style="field-sizing: content" size="1"
                        placeholder="example.com" spellcheck="false" autocomplete="off">
                    {% endif %}
                </div>
                {# MAC ‚Äî read-only (hardware reported) #}
                <div class="flex flex-col gap-1">
                    <span class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider font-medium">MAC</span>
                    <span class="text-sm text-cyan-600 dark:text-cyan-400 tech-mono" x-text="machine.mac_address || 'N/A'"></span>
                </div>
                {# Network Mode ‚Äî per-field custom dropdown #}
                <div class="flex flex-col gap-1 relative">
                    <span class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider font-medium">Mode <span x-show="isFieldPending('network_mode')" x-cloak class="text-green-500 dark:text-green-400 normal-case tracking-normal font-normal">(Pending)</span><span x-show="isFieldSavedPending('network_mode')" x-cloak class="text-yellow-500 dark:text-yellow-400 normal-case tracking-normal font-normal">(Pending)</span></span>
                    <span
                        class="text-sm text-blue-600 dark:text-blue-400 font-medium self-start {% if is_authenticated %}cursor-pointer hover:underline{% endif %}"
                        :class="editingField === 'network_mode' ? 'border-b-2 border-purple-500' : ''"
                        {% if is_authenticated %}@click="editingField === 'network_mode' ? cancelFieldEdit() : startFieldEdit('network_mode', machine.network_mode || 'dhcp')"{% endif %}
                        x-text="networkModeLabel(machine.network_mode)"></span>
                    {% if is_authenticated %}
                    <div x-show="editingField === 'network_mode'" x-cloak
                        @keydown.escape.window="editingField === 'network_mode' && cancelFieldEdit()"
                        @click.outside="editingField === 'network_mode' && cancelFieldEdit()"
                        class="absolute top-full left-0 mt-1 z-20 min-w-[180px] rounded-lg border border-gray-200 dark:border-[#333] bg-white dark:bg-[#1a1a1a] shadow-lg py-1">
                        <template x-for="opt in [
                            {v: 'dhcp', l: 'DHCP'},
                            {v: 'dhcp_static_dns', l: 'DHCP + Static DNS'},
                            {v: 'static_ipv4', l: 'Static IPv4'},
                            {v: 'static_ipv6', l: 'Static IPv6'},
                            {v: 'static_dual_stack', l: 'Static Dual Stack'}
                        ]" :key="opt.v">
                            <button type="button"
                                @click="commitDropdown('network_mode', opt.v)"
                                class="w-full text-left px-3 py-1.5 text-sm transition-colors"
                                :class="machine.network_mode === opt.v
                                    ? 'text-blue-600 dark:text-blue-400 font-medium bg-blue-50 dark:bg-blue-900/20'
                                    : 'text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-[#222]'"
                                x-text="opt.l"></button>
                        </template>
                    </div>
                    {% endif %}
                </div>
                {# IP Address ‚Äî read-only (reported by agent) #}
                <div class="flex flex-col gap-1">
                    <span class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider font-medium">IP Address</span>
                    <span class="text-sm text-emerald-600 dark:text-emerald-400 tech-mono" x-text="machine.ip_address || 'Not assigned'"></span>
                </div>

                {# Static IPv4 ‚Äî shown when mode is static, each field individually editable #}
                <template x-if="machine.network_mode === 'static_ipv4' || machine.network_mode === 'static_dual_stack'">
                    <div class="col-span-2 grid grid-cols-3 gap-3 border-t border-gray-100 dark:border-[#222] pt-3">
                        <div class="flex flex-col gap-0.5">
                            <span class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider font-medium"><span class="normal-case">IPv4</span> Address</span>
                            <span x-show="editingField !== 'static_ipv4_address'"
                                {% if is_authenticated %}@click="startFieldEdit('static_ipv4_address', (machine.static_ipv4 && machine.static_ipv4.address) || '')"{% endif %}
                                class="text-sm text-emerald-600 dark:text-emerald-400 tech-mono {% if is_authenticated %}cursor-pointer hover:underline{% endif %}"
                                x-text="(machine.static_ipv4 && machine.static_ipv4.address) || 'Not set'"></span>
                            <input x-show="editingField === 'static_ipv4_address'" x-cloak
                                x-ref="edit_static_ipv4_address"
                                :value="editValue" @input="editValue = $event.target.value"
                                @keydown.enter="commitStaticField('ipv4', 'address')"
                                @keydown.escape="cancelFieldEdit()"
                                @keydown="if ($event.key === '/') { $event.preventDefault(); commitStaticField('ipv4', 'address', false); startFieldEdit('static_ipv4_prefix', String((machine.static_ipv4 && machine.static_ipv4.prefix_len) || '24')); }"
                                @blur="editingField === 'static_ipv4_address' && commitStaticField('ipv4', 'address')"
                                class="text-sm tech-mono bg-transparent border-b-2 border-purple-500 outline-none text-emerald-600 dark:text-emerald-400"
                                style="field-sizing: content"
                                placeholder="192.168.1.100" spellcheck="false" autocomplete="off">
                            <span x-show="isFieldPending('static_ipv4')" x-cloak class="text-xs text-green-500 dark:text-green-400">(Pending)</span>
                            <span x-show="isFieldSavedPending('static_ipv4')" x-cloak class="text-xs text-yellow-500 dark:text-yellow-400">(Pending)</span>
                        </div>
                        <div class="flex flex-col gap-1">
                            <span class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider font-medium">Prefix</span>
                            <span x-show="editingField !== 'static_ipv4_prefix'"
                                {% if is_authenticated %}@click="startFieldEdit('static_ipv4_prefix', String((machine.static_ipv4 && machine.static_ipv4.prefix_len) || '24'))"{% endif %}
                                class="text-sm text-gray-700 dark:text-gray-300 tech-mono {% if is_authenticated %}cursor-pointer hover:underline{% endif %}"
                                x-text="'/' + ((machine.static_ipv4 && machine.static_ipv4.prefix_len) || '24')"></span>
                            <input x-show="editingField === 'static_ipv4_prefix'" x-cloak
                                x-ref="edit_static_ipv4_prefix" type="number" min="1" max="32"
                                :value="editValue" @input="editValue = $event.target.value"
                                @keydown.enter="commitStaticField('ipv4', 'prefix_len')"
                                @keydown.escape="cancelFieldEdit()"
                                @blur="editingField === 'static_ipv4_prefix' && commitStaticField('ipv4', 'prefix_len')"
                                class="text-sm tech-mono bg-transparent border-b-2 border-purple-500 outline-none text-gray-700 dark:text-gray-300 w-12"
                                placeholder="24" spellcheck="false" autocomplete="off">
                        </div>
                        <div class="flex flex-col gap-1">
                            <span class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider font-medium">Gateway</span>
                            <span x-show="editingField !== 'static_ipv4_gateway'"
                                {% if is_authenticated %}@click="startFieldEdit('static_ipv4_gateway', (machine.static_ipv4 && machine.static_ipv4.gateway) || '')"{% endif %}
                                class="text-sm text-gray-700 dark:text-gray-300 tech-mono {% if is_authenticated %}cursor-pointer hover:underline{% endif %}"
                                x-text="(machine.static_ipv4 && machine.static_ipv4.gateway) || 'Not set'"></span>
                            <input x-show="editingField === 'static_ipv4_gateway'" x-cloak
                                x-ref="edit_static_ipv4_gateway"
                                :value="editValue" @input="editValue = $event.target.value"
                                @keydown.enter="commitStaticField('ipv4', 'gateway')"
                                @keydown.escape="cancelFieldEdit()"
                                @blur="editingField === 'static_ipv4_gateway' && commitStaticField('ipv4', 'gateway')"
                                class="text-sm tech-mono bg-transparent border-b-2 border-purple-500 outline-none text-gray-700 dark:text-gray-300"
                                style="field-sizing: content"
                                placeholder="192.168.1.1" spellcheck="false" autocomplete="off">
                        </div>
                    </div>
                </template>

                {# Static IPv6 ‚Äî shown when mode is static v6 #}
                <template x-if="machine.network_mode === 'static_ipv6' || machine.network_mode === 'static_dual_stack'">
                    <div class="col-span-2 grid grid-cols-3 gap-3 border-t border-gray-100 dark:border-[#222] pt-3">
                        <div class="flex flex-col gap-1">
                            <span class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider font-medium"><span class="normal-case">IPv6</span> Address</span>
                            <span x-show="editingField !== 'static_ipv6_address'"
                                {% if is_authenticated %}@click="startFieldEdit('static_ipv6_address', (machine.static_ipv6 && machine.static_ipv6.address) || '')"{% endif %}
                                class="text-sm text-emerald-600 dark:text-emerald-400 tech-mono {% if is_authenticated %}cursor-pointer hover:underline{% endif %}"
                                x-text="(machine.static_ipv6 && machine.static_ipv6.address) || 'Not set'"></span>
                            <input x-show="editingField === 'static_ipv6_address'" x-cloak
                                x-ref="edit_static_ipv6_address"
                                :value="editValue" @input="editValue = $event.target.value"
                                @keydown.enter="commitStaticField('ipv6', 'address')"
                                @keydown.escape="cancelFieldEdit()"
                                @keydown="if ($event.key === '/') { $event.preventDefault(); commitStaticField('ipv6', 'address', false); startFieldEdit('static_ipv6_prefix', String((machine.static_ipv6 && machine.static_ipv6.prefix_len) || '64')); }"
                                @blur="editingField === 'static_ipv6_address' && commitStaticField('ipv6', 'address')"
                                class="text-sm tech-mono bg-transparent border-b-2 border-purple-500 outline-none text-emerald-600 dark:text-emerald-400"
                                style="field-sizing: content"
                                placeholder="2001:db8::1" spellcheck="false" autocomplete="off">
                        </div>
                        <div class="flex flex-col gap-1">
                            <span class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider font-medium">Prefix</span>
                            <span x-show="editingField !== 'static_ipv6_prefix'"
                                {% if is_authenticated %}@click="startFieldEdit('static_ipv6_prefix', String((machine.static_ipv6 && machine.static_ipv6.prefix_len) || '64'))"{% endif %}
                                class="text-sm text-gray-700 dark:text-gray-300 tech-mono {% if is_authenticated %}cursor-pointer hover:underline{% endif %}"
                                x-text="'/' + ((machine.static_ipv6 && machine.static_ipv6.prefix_len) || '64')"></span>
                            <input x-show="editingField === 'static_ipv6_prefix'" x-cloak
                                x-ref="edit_static_ipv6_prefix" type="number" min="1" max="128"
                                :value="editValue" @input="editValue = $event.target.value"
                                @keydown.enter="commitStaticField('ipv6', 'prefix_len')"
                                @keydown.escape="cancelFieldEdit()"
                                @blur="editingField === 'static_ipv6_prefix' && commitStaticField('ipv6', 'prefix_len')"
                                class="text-sm tech-mono bg-transparent border-b-2 border-purple-500 outline-none text-gray-700 dark:text-gray-300 w-12"
                                placeholder="64" spellcheck="false" autocomplete="off">
                        </div>
                        <div class="flex flex-col gap-1">
                            <span class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider font-medium">Gateway</span>
                            <span x-show="editingField !== 'static_ipv6_gateway'"
                                {% if is_authenticated %}@click="startFieldEdit('static_ipv6_gateway', (machine.static_ipv6 && machine.static_ipv6.gateway) || '')"{% endif %}
                                class="text-sm text-gray-700 dark:text-gray-300 tech-mono {% if is_authenticated %}cursor-pointer hover:underline{% endif %}"
                                x-text="(machine.static_ipv6 && machine.static_ipv6.gateway) || 'Not set'"></span>
                            <input x-show="editingField === 'static_ipv6_gateway'" x-cloak
                                x-ref="edit_static_ipv6_gateway"
                                :value="editValue" @input="editValue = $event.target.value"
                                @keydown.enter="commitStaticField('ipv6', 'gateway')"
                                @keydown.escape="cancelFieldEdit()"
                                @blur="editingField === 'static_ipv6_gateway' && commitStaticField('ipv6', 'gateway')"
                                class="text-sm tech-mono bg-transparent border-b-2 border-purple-500 outline-none text-gray-700 dark:text-gray-300"
                                style="field-sizing: content"
                                placeholder="2001:db8::1" spellcheck="false" autocomplete="off">
                        </div>
                    </div>
                </template>

                {# Nameservers ‚Äî inline horizontal editing, no reflow #}
                <div class="col-span-2 flex flex-col gap-1 border-t border-gray-100 dark:border-[#222] pt-3"
                    @click.outside="editingField === 'nameservers' && commitNameservers()"
                    @keydown.escape.window="editingField === 'nameservers' && commitNameservers()">
                    <span class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider font-medium">DNS Nameservers <span x-show="isFieldPending('nameservers')" x-cloak class="text-green-500 dark:text-green-400 normal-case tracking-normal font-normal">(Pending)</span><span x-show="isFieldSavedPending('nameservers')" x-cloak class="text-yellow-500 dark:text-yellow-400 normal-case tracking-normal font-normal">(Pending)</span></span>
                    <div class="flex flex-wrap items-center gap-2">
                        <template x-if="editingField !== 'nameservers'">
                            <template x-for="(ns, idx) in (machine.nameservers || [])" :key="ns + '-' + idx">
                                <span class="text-sm text-gray-700 dark:text-gray-300 tech-mono px-2 py-0.5 rounded bg-gray-100 dark:bg-[#1a1a1a] {% if is_authenticated %}cursor-pointer hover:bg-gray-200 dark:hover:bg-[#222]{% endif %}"
                                    {% if is_authenticated %}@click="startNameserverEdit()"{% endif %}
                                    x-text="ns"></span>
                            </template>
                        </template>
                        <template x-if="editingField !== 'nameservers' && (!machine.nameservers || machine.nameservers.length === 0)">
                            <span class="text-sm text-gray-400 dark:text-gray-500 italic {% if is_authenticated %}cursor-pointer{% endif %}"
                                {% if is_authenticated %}@click="startNameserverEdit(); editableNameservers.push('')"{% endif %}>None configured</span>
                        </template>
                        {% if is_authenticated %}
                        <template x-if="editingField === 'nameservers'">
                            <template x-for="(ns, idx) in editableNameservers" :key="idx">
                                <span class="group inline-flex items-center bg-gray-100 dark:bg-[#1a1a1a] rounded relative">
                                    <input type="text" x-model="editableNameservers[idx]" placeholder="0.0.0.0" spellcheck="false" autocomplete="off"
                                        class="text-sm tech-mono bg-transparent outline-none text-gray-900 dark:text-gray-100 px-2 py-0.5 border-b border-transparent focus:border-purple-500"
                                        style="field-sizing: content"
                                        @keydown.enter="$event.target.blur()"
                                        @blur="syncNameservers()">
                                    <button @click="editableNameservers.splice(idx, 1); syncNameservers(); if (editableNameservers.length === 0) cancelFieldEdit()" type="button"
                                        class="text-red-400 hover:text-red-300 text-xs -ml-1 pr-1 transition-colors">&times;</button>
                                </span>
                            </template>
                        </template>
                        <template x-if="editingField === 'nameservers'">
                            <button @click="editableNameservers.push(''); $nextTick(() => { const inputs = $el.closest('.flex-wrap').querySelectorAll('input'); inputs[inputs.length - 1]?.focus(); })" type="button"
                                class="text-purple-500 dark:text-purple-400 hover:text-purple-700 dark:hover:text-purple-300 text-sm font-bold px-1 transition-colors" title="Add nameserver">+</button>
                        </template>
                        <template x-if="editingField !== 'nameservers' && machine.nameservers && machine.nameservers.length > 0">
                            <button @click="startNameserverEdit(); editableNameservers.push(''); $nextTick(() => { const inputs = $el.closest('.flex-wrap').querySelectorAll('input'); inputs[inputs.length - 1]?.focus(); })" type="button"
                                class="text-purple-500 dark:text-purple-400 hover:text-purple-700 dark:hover:text-purple-300 text-sm font-bold px-1 transition-colors" title="Add nameserver">+</button>
                        </template>
                        {% endif %}
                    </div>
                </div>

                {# Proxmox cluster info #}
                <template x-if="machine.proxmox_cluster">
                    <div class="flex flex-col gap-1">
                        <span class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider font-medium">Cluster</span>
                        <span class="text-sm text-purple-600 dark:text-purple-400" x-text="machine.proxmox_cluster"></span>
                    </div>
                </template>
                <template x-if="machine.proxmox_node">
                    <div class="flex flex-col gap-1">
                        <span class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider font-medium">Type</span>
                        <span class="text-sm text-gray-700 dark:text-gray-300">Proxmox</span>
                    </div>
                </template>
                {# Memorable Name #}
                <div class="flex flex-col gap-1">
                    <span class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider font-medium">Memorable Name <span x-show="isFieldPending('memorable_name')" x-cloak class="text-green-500 dark:text-green-400 normal-case tracking-normal font-normal">(Pending)</span><span x-show="isFieldSavedPending('memorable_name')" x-cloak class="text-yellow-500 dark:text-yellow-400 normal-case tracking-normal font-normal">(Pending)</span></span>
                    <span x-show="editingField !== 'memorable_name'"
                        class="text-sm text-gray-700 dark:text-gray-300 self-start {% if is_authenticated %}cursor-pointer hover:underline{% endif %}"
                        {% if is_authenticated %}@click="startFieldEdit('memorable_name', machine.memorable_name || '')"{% endif %}
                        x-text="machine.memorable_name || 'Not set'"></span>
                    <input x-show="editingField === 'memorable_name'" x-cloak
                        x-ref="edit_memorable_name"
                        :value="editValue" @input="editValue = $event.target.value"
                        @keydown.enter="commitField('memorable_name')"
                        @keydown.escape="cancelFieldEdit()"
                        @blur="editingField === 'memorable_name' && commitField('memorable_name')"
                        class="text-sm bg-transparent border-b-2 border-purple-500 outline-none text-gray-700 dark:text-gray-300"
                        style="field-sizing: content"
                        placeholder="Memorable name" spellcheck="false" autocomplete="off">
                </div>
                {# Network ‚Äî clickable VLAN assignment #}
                <div class="flex flex-col gap-1 relative">
                    <span class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider font-medium">Network <span x-show="isFieldPending('network_id')" x-cloak class="text-green-500 dark:text-green-400 normal-case tracking-normal font-normal">(Pending)</span><span x-show="isFieldSavedPending('network_id')" x-cloak class="text-yellow-500 dark:text-yellow-400 normal-case tracking-normal font-normal">(Pending)</span></span>
                    <span
                        class="text-sm text-blue-600 dark:text-blue-400 font-medium self-start {% if is_authenticated %}cursor-pointer hover:underline{% endif %}"
                        {% if is_authenticated %}@click="editingField === 'network_select' ? cancelFieldEdit() : startFieldEdit('network_select', machine.network_id || '')"{% endif %}
                        x-text="networkName()"></span>
                    {% if is_authenticated %}
                    <div x-show="editingField === 'network_select'" x-cloak
                        @keydown.escape.window="editingField === 'network_select' && cancelFieldEdit()"
                        @click.outside="editingField === 'network_select' && cancelFieldEdit()"
                        class="absolute top-full left-0 mt-1 z-20 min-w-[200px] rounded-lg border border-gray-200 dark:border-[#333] bg-white dark:bg-[#1a1a1a] shadow-lg py-1">
                        <button type="button" @click="commitDropdown('network_id', '')"
                            class="w-full text-left px-3 py-1.5 text-sm transition-colors"
                            :class="!machine.network_id
                                ? 'text-blue-600 dark:text-blue-400 font-medium bg-blue-50 dark:bg-blue-900/20'
                                : 'text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-[#222]'">Default</button>
                        <template x-for="net in networks" :key="net.id">
                            <button type="button" @click="commitDropdown('network_id', net.id)"
                                class="w-full text-left px-3 py-1.5 text-sm transition-colors"
                                :class="machine.network_id === net.id
                                    ? 'text-blue-600 dark:text-blue-400 font-medium bg-blue-50 dark:bg-blue-900/20'
                                    : 'text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-[#222]'"
                                x-text="net.name + (net.vlan_id ? ' (VLAN ' + net.vlan_id + ')' : '')"></button>
                        </template>
                        <div class="border-t border-gray-100 dark:border-[#333] mt-1 pt-1">
                            <template x-if="!createNetworkInline">
                                <button type="button" @click="createNetworkInline = true; $nextTick(() => $refs.newNetName?.focus())"
                                    class="w-full text-left px-3 py-1.5 text-sm text-purple-600 dark:text-purple-400 hover:bg-purple-50 dark:hover:bg-purple-900/10 transition-colors font-medium">+ Create network</button>
                            </template>
                            <template x-if="createNetworkInline">
                                <div class="px-3 py-2 space-y-2">
                                    <input type="text" x-ref="newNetName" x-model="newNetwork.name" placeholder="Network name"
                                        class="w-full text-sm bg-transparent border-b border-gray-300 dark:border-gray-600 outline-none text-gray-900 dark:text-gray-100 py-1 focus:border-purple-500"
                                        @keydown.enter="newNetwork.name.trim() && createNetwork()"
                                        @keydown.escape="createNetworkInline = false; newNetwork = { name: '' }">
                                    <input type="text" x-model="newNetwork.vlan_id" placeholder="VLAN ID (optional)"
                                        class="w-full text-sm bg-transparent border-b border-gray-300 dark:border-gray-600 outline-none text-gray-900 dark:text-gray-100 py-1 focus:border-purple-500"
                                        @keydown.enter="newNetwork.name.trim() && createNetwork()"
                                        @keydown.escape="createNetworkInline = false; newNetwork = { name: '' }">
                                    <div class="flex gap-2 pt-1">
                                        <button type="button" @click="createNetwork()" :disabled="!newNetwork.name.trim()"
                                            class="text-xs text-white bg-purple-600 hover:bg-purple-700 px-2 py-1 rounded transition-colors disabled:opacity-50">Create</button>
                                        <button type="button" @click="createNetworkInline = false; newNetwork = { name: '' }"
                                            class="text-xs text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">Cancel</button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# ===== STORAGE (full width) ===== #}
    <div class="rounded-xl border border-gray-200 dark:border-[#1a1a1a] bg-white dark:bg-[#111] p-5 mb-6">
        <div class="mb-4">
            <h2 class="text-sm font-semibold text-gray-500 dark:text-gray-500 uppercase tracking-wider">Storage</h2>
        </div>
        <template x-if="machine.disks && machine.disks.length > 0">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-gray-100 dark:border-[#222]">
                        <th class="text-left text-[11px] text-gray-400 dark:text-gray-400 uppercase tracking-wider pb-2 font-medium">Device</th>
                        <th class="text-left text-[11px] text-gray-400 dark:text-gray-400 uppercase tracking-wider pb-2 font-medium">Size</th>
                        <th class="text-left text-[11px] text-gray-400 dark:text-gray-400 uppercase tracking-wider pb-2 font-medium">Model</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="disk in machine.disks" :key="disk.device">
                        <tr class="border-b border-gray-50 dark:border-[#1a1a1a] last:border-0">
                            <td class="py-3 text-sm tech-mono text-purple-600 dark:text-purple-400" x-text="disk.device"></td>
                            <td class="py-3 text-sm text-gray-700 dark:text-gray-300" x-text="disk.size_bytes ? formatDiskSize(disk.size_bytes) : 'Unknown'"></td>
                            <td class="py-3 text-sm text-gray-700 dark:text-gray-300" x-text="disk.model || 'Unknown'"></td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </template>
        <template x-if="!machine.disks || machine.disks.length === 0">
            <p class="text-sm text-gray-400 dark:text-gray-500 italic">No storage devices detected</p>
        </template>
    </div>

    </div>{# /flex-1 content #}
    </div>{# /flex sidebar+content layout #}

    {# Create Network is now inline within the network dropdown popover #}

    {# ===== DELETE MACHINE MODAL ===== #}
    <div x-show="deleteModalOpen"
         x-cloak
         class="fixed inset-0 z-50 overflow-y-auto"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div @click="deleteModalOpen = false" class="fixed inset-0 bg-gray-500 dark:bg-gray-900 bg-opacity-75 dark:bg-opacity-75 transition-opacity" aria-hidden="true"></div>

            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-red-600 dark:text-red-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
                                Delete Machine
                            </h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500 dark:text-gray-400">
                                    Are you sure you want to delete this machine? This action cannot be undone.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button @click="deleteMachine()"
                            :disabled="isDeleting"
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm"
                            :class="{'opacity-50 cursor-not-allowed': isDeleting}">
                        <span x-show="isDeleting">
                            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Deleting...
                        </span>
                        <span x-show="!isDeleting">Delete</span>
                    </button>
                    <button @click="deleteModalOpen = false"
                            :disabled="isDeleting"
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"
                            :class="{'opacity-50 cursor-not-allowed': isDeleting}">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    {# ===== EVACUATE COMING SOON MODAL ===== #}
    <div x-show="evacuateModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto"
        x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-150"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0">
        <div class="fixed inset-0 bg-black/40" @click="evacuateModal = false"></div>
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative bg-white dark:bg-gray-900 rounded-lg p-6 max-w-md shadow-xl" @click.stop>
                <div class="flex items-center gap-3 mb-4">
                    <div class="flex h-10 w-10 items-center justify-center rounded-full bg-yellow-100 dark:bg-yellow-900/30">
                        <i data-lucide="life-buoy" class="w-5 h-5 text-yellow-600 dark:text-yellow-400"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Evacuate</h3>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">
                    Evacuate will securely back up this machine to the Dragonfly server, verify the backup end-to-end, then wipe the remote node. This feature is coming soon.
                </p>
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">
                    Track progress: create a <strong>FLY</strong> ticket in Plane to request this feature.
                </p>
                <button @click="evacuateModal = false"
                    class="w-full px-4 py-2 text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors">
                    Got it
                </button>
            </div>
        </div>
    </div>

    {# ===== REIMAGE CONFIRMATION MODAL ===== #}
    <div x-show="reimageConfirmModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto"
        x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-150"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0">
        <div class="fixed inset-0 bg-black/40" @click="reimageConfirmModal = false"></div>
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative bg-white dark:bg-gray-900 rounded-lg p-6 max-w-md shadow-xl" @click.stop>
                <div class="flex items-center gap-3 mb-4">
                    <div class="flex h-10 w-10 items-center justify-center rounded-full bg-red-100 dark:bg-red-900/30">
                        <i data-lucide="eraser" class="w-5 h-5 text-red-600 dark:text-red-400"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Reimage Machine</h3>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">
                    This will <strong class="text-red-600 dark:text-red-400">wipe and reinstall</strong> the operating system on this machine.
                </p>
                <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">
                    OS: <strong class="text-gray-900 dark:text-white" x-text="osNames[machine.os_choice] || osNames[machine.os_installed] || machine.os_choice || machine.os_installed || 'Unknown'"></strong>
                </p>
                <div class="flex gap-3">
                    <button @click="reimageConfirmModal = false"
                        class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button @click="doReimage()"
                        class="flex-1 px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-lg transition-colors">
                        Reimage
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
  // Define helper functions in the script scope
  const formatStatus = (s) => s ? s.replace(/([a-z])([A-Z])/g, '$1 $2').replace(/ (To|Of|In|On|At|By|For|The|A|An) /g, (m) => m.toLowerCase()) : s;

  // FLY-50: Binary bytes for RAM (1024-based, GiB/MiB/KiB)
  const formatBinaryBytes = (bytes, decimals = 1) => {
      if (!bytes || bytes === 0) return '0 Bytes';
      const k = 1024;
      const dm = decimals < 0 ? 0 : decimals;
      const sizes = ['Bytes', 'KiB', 'MiB', 'GiB', 'TiB', 'PiB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
  };

  // FLY-50: Decimal bytes for disks (1000-based, GB/TB)
  const formatDiskSize = (bytes, decimals = 1) => {
      if (!bytes || bytes === 0) return '0 Bytes';
      const k = 1000;
      const dm = decimals < 0 ? 0 : decimals;
      const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
  };

  // Keep formatBytes as alias for backward compat (uses binary)
  const formatBytes = formatBinaryBytes;
  const findMatchingStreamTasks = (fileName) => {
      const taskRows = document.querySelectorAll('#tasks-table-body tr[data-task-name]');
      const matchingRows = [];
      taskRows.forEach(row => {
          const taskNameAttr = row.getAttribute('data-task-name').toLowerCase();
          const fileNameLower = (fileName || '').toLowerCase();
          if (taskNameAttr.startsWith('stream image') || (fileNameLower && taskNameAttr.includes(fileNameLower))) {
              if (!taskNameAttr.includes('complete') && !taskNameAttr.includes('failed')) {
                  matchingRows.push(row);
              }
          }
      });
      if (matchingRows.length === 0) {
          taskRows.forEach(row => {
              const taskNameAttr = row.getAttribute('data-task-name').toLowerCase();
              if (taskNameAttr.startsWith('stream image')) {
                  if (!taskNameAttr.includes('complete') && !taskNameAttr.includes('failed')) {
                      matchingRows.push(row);
                  }
              }
          });
      }
      return matchingRows;
  };
  const startProgressAnimation = (element) => {
      if (element && !element.classList.contains('animate-progress')) {
          element.classList.add('animate-progress');
      }
  };
  const stopProgressAnimation = (element) => {
       if (element) {
          element.classList.remove('animate-progress');
      }
  };

  // Alpine component function
  function machineDetailsData() {
    return {
        // --- Properties ---
        machine: {
            id: null,
            status: 'Loading...',
            hostname: null,
            ip_address: null,
            mac_address: null,
            memorable_name: null,
            os_choice: null,
            disks: [],
            nameservers: [],
            tags: [],
            last_deployment_duration: null,
            bmc_credentials: null
        },
        workflow_info: null,
        machineId: '',
        machineIp: '',
        taskProgressState: {},
        evtSource: null,
        selectedStatus: '',
        fetchDebounceTimer: null,
        error: null,

        // Per-field click-to-edit
        editingField: null,
        editValue: '',

        // Accumulated per-field changes (saved with Save, discarded with Cancel)
        pendingChanges: {},
        editableNameservers: [],
        editFormError: '',
        isSubmitting: false,

        // Power/action in progress
        actionInProgress: null,

        // Delete modal properties
        deleteModalOpen: false,
        isDeleting: false,

        // Evacuate modal
        evacuateModal: false,

        // Reimage confirm modal
        reimageConfirmModal: false,

        // Tag modal
        addTagModal: false,

        // Templates list (for OS dropdown)
        templates: [],

        // Live install progress (from workflow_progress SSE events)
        liveProgress: { percent: 0, action: '', message: '', bytesTransferred: 0, bytesTotal: 0 },

        // Networks
        networks: [],
        createNetworkInline: false,
        newNetwork: { name: '', vlan_id: '' },

        // IP Address Type
        ipAddressType: 'Unknown',

        // OS display name mapping (loaded from /static/os_names.json)
        osNames: {},

        // --- Methods ---

        // Per-field click-to-edit methods
        startFieldEdit(field, currentValue) {
            this.editingField = field;
            this.editValue = currentValue;
            this.$nextTick(() => {
                const ref = this.$refs['edit_' + field];
                if (ref) ref.focus();
            });
        },

        cancelFieldEdit() {
            this.editingField = null;
            this.editValue = '';
        },

        // Measure exact pixel width of text using the element's computed font
        measureTextWidth(el, text) {
            if (!this._measureCtx) {
                this._measureCtx = document.createElement('canvas').getContext('2d');
            }
            this._measureCtx.font = getComputedStyle(el).font;
            return Math.ceil(this._measureCtx.measureText(text).width) + 4;
        },

        deleteMachine() {
            this.isDeleting = true;

            fetch(`/api/machines/${this.machine.id}`, {
                method: 'DELETE',
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || `HTTP error! status: ${response.status}`);
                    });
                }
                return response.text();
            })
            .then(() => {
                if (window.showToast) {
                    window.showToast(`Machine deleted successfully`, 'success');
                }
                window.location.href = '/machines';
            })
            .catch(error => {
                if (window.showToast) {
                    window.showToast(`Failed to delete machine: ${error.message}`, 'error');
                }
                console.error('Error deleting machine:', error);
                this.deleteModalOpen = false;
            })
            .finally(() => {
                this.isDeleting = false;
            });
        },

        removeTag(tag) {
            // Tag removal - will be wired up when tag API exists
            console.log('Remove tag:', tag);
        },

        networkModeLabel(mode) {
            const labels = {
                'dhcp': 'DHCP',
                'dhcp_static_dns': 'DHCP + Static DNS',
                'static_ipv4': 'Static IPv4',
                'static_ipv6': 'Static IPv6',
                'static_dual_stack': 'Static Dual Stack',
            };
            return labels[mode] || mode || 'DHCP';
        },

        // Domain display: look up network by machine.network_id
        domainValue() {
            if (!this.machine.network_id) return 'N/A';
            const net = this.networks.find(n => n.id === this.machine.network_id);
            return net && net.domain ? net.domain : 'N/A';
        },

        // Network name display ‚Äî "Default" for unassigned VLAN 0 machines
        networkName() {
            if (!this.machine.network_id) {
                // Machine is on the native/untagged VLAN (same as Dragonfly host)
                return 'Default';
            }
            const net = this.networks.find(n => n.id === this.machine.network_id);
            return net ? net.name : 'Unknown';
        },

        // Check if a field has a pending (unsaved local) change ‚Äî green
        isFieldPending(field) {
            return this.pendingChanges.hasOwnProperty(field);
        },

        // Check if a field is saved to DB but not yet applied to host ‚Äî yellow
        isFieldSavedPending(field) {
            return !this.isFieldPending(field) && (this.machine.pending_fields || []).includes(field);
        },

        // Are there any unsaved local changes?
        hasPendingChanges() {
            return Object.keys(this.pendingChanges).length > 0;
        },

        // Revert saved-but-not-applied changes (clear pending state on server)
        revertPendingChanges() {
            fetch(`/api/machines/${this.machine.id}/revert-pending`, { method: 'POST' })
                .then(r => {
                    if (!r.ok) throw new Error('Revert failed');
                    return r.json();
                })
                .then(data => {
                    if (data && data.id) {
                        this.machine = data;
                        this._originalMachine = JSON.parse(JSON.stringify(data));
                    }
                    if (window.showToast) window.showToast('Pending changes reverted', 'success');
                })
                .catch(e => {
                    if (window.showToast) window.showToast('Revert failed: ' + e.message, 'error');
                });
        },

        // Check if a value matches the original server state for a field
        _matchesOriginal(field, value) {
            if (!this._originalMachine) return false;
            const orig = this._originalMachine[field];
            // Normalize: treat null/undefined/'' as equivalent
            const a = (value === null || value === undefined || value === '') ? '' : value;
            const b = (orig === null || orig === undefined || orig === '') ? '' : orig;
            return a === b;
        },

        // Track a pending change, or remove it if it's back to the original value
        _setPending(field, value) {
            if (this._matchesOriginal(field, value)) {
                const copy = { ...this.pendingChanges };
                delete copy[field];
                this.pendingChanges = copy;
            } else {
                this.pendingChanges = { ...this.pendingChanges, [field]: value };
            }
        },

        // Commit a simple text field locally (Enter or blur)
        commitField(field, closeAfter = true) {
            let value = this.editValue.trim();
            // If memorable_name is cleared, revert to MAC-derived original
            if (field === 'memorable_name' && !value) {
                value = this._originalMemorableName || '';
            }
            this.machine[field] = value || null; // visual feedback (null for display)
            // Send "" not null ‚Äî server needs Some("") to distinguish "clear" from "not sent"
            this._setPending(field, value);
            if (closeAfter) this.cancelFieldEdit();
        },

        // Commit a dropdown selection locally
        commitDropdown(field, value) {
            this.machine[field] = value;
            this._setPending(field, value || null);
            // Switching to plain DHCP ‚Üí restore nameservers from what DHCP reported
            if (field === 'network_mode' && value === 'dhcp' && this.machine.reported_nameservers?.length) {
                this.machine.nameservers = [...this.machine.reported_nameservers];
                this.editableNameservers = [...this.machine.reported_nameservers];
                this._setPending('nameservers', [...this.machine.reported_nameservers]);
            }
            this.cancelFieldEdit();
        },

        // Commit a static IP sub-field locally
        commitStaticField(version, subfield, closeAfter = true) {
            const value = this.editValue.trim();
            const key = 'static_' + version; // static_ipv4 or static_ipv6
            if (!this.machine[key]) {
                this.machine[key] = { address: '', prefix_len: version === 'ipv4' ? 24 : 64, gateway: null };
            }
            const parsedValue = subfield === 'prefix_len' ? parseInt(value, 10) : (value || null);
            this.machine[key][subfield] = parsedValue;

            // Auto-calculate gateway when address + prefix are both set
            if ((subfield === 'address' || subfield === 'prefix_len') && version === 'ipv4') {
                const addr = this.machine[key].address;
                const prefix = this.machine[key].prefix_len;
                if (addr && prefix && !this.machine[key].gateway) {
                    const gw = this._autoGateway(addr, prefix);
                    if (gw) this.machine[key].gateway = gw;
                }
            }

            // Update displayed IP to match configured static address
            if (subfield === 'address' && version === 'ipv4' && this.machine[key].address) {
                this.machine.ip_address = this.machine[key].address;
            }

            const newBlock = { ...this.machine[key] };
            // Compare to original ‚Äî if identical, remove from pending
            const orig = this._originalMachine ? this._originalMachine[key] : null;
            if (orig && JSON.stringify(newBlock) === JSON.stringify(orig)) {
                const copy = { ...this.pendingChanges };
                delete copy[key];
                this.pendingChanges = copy;
            } else {
                this.pendingChanges = { ...this.pendingChanges, [key]: newBlock };
            }
            if (closeAfter) this.cancelFieldEdit();
        },

        // Commit CPU cores edit (Proxmox VMs only)
        commitCpuCores() {
            const val = parseInt(this.editValue, 10);
            if (!val || val < 1) { this.cancelFieldEdit(); return; }
            this.machine.cpu_cores = val;
            this._setPending('cpu_cores', val);
            this.cancelFieldEdit();
        },

        // Commit RAM edit in GiB (Proxmox VMs only)
        commitRamGib() {
            const gib = parseFloat(this.editValue);
            if (!gib || gib <= 0) { this.cancelFieldEdit(); return; }
            const bytes = Math.round(gib * 1024 * 1024 * 1024);
            this.machine.total_ram_bytes = bytes;
            this._setPending('total_ram_bytes', bytes);
            this.cancelFieldEdit();
        },

        // Calculate first usable address in subnet as default gateway
        _autoGateway(addr, prefix) {
            const parts = addr.split('.').map(Number);
            if (parts.length !== 4 || parts.some(p => isNaN(p) || p < 0 || p > 255)) return null;
            if (prefix < 1 || prefix > 30) return null;
            const ip = (parts[0] << 24) | (parts[1] << 16) | (parts[2] << 8) | parts[3];
            const mask = (~0 << (32 - prefix)) >>> 0;
            const network = (ip & mask) >>> 0;
            const gateway = (network + 1) >>> 0;
            return [(gateway >>> 24) & 0xff, (gateway >>> 16) & 0xff, (gateway >>> 8) & 0xff, gateway & 0xff].join('.');
        },

        // Start editing nameservers (isolated from other fields)
        startNameserverEdit() {
            this.editableNameservers = this.machine.nameservers ? [...this.machine.nameservers] : [];
            this.editingField = 'nameservers';
        },

        // Sync nameserver edits to pendingChanges without closing edit mode
        syncNameservers() {
            const cleaned = this.editableNameservers.filter(ns => ns.trim() !== '');
            this.machine.nameservers = cleaned;
            // Compare to original
            const origNs = (this._originalMachine && this._originalMachine.nameservers) || [];
            const nsChanged = JSON.stringify(cleaned) !== JSON.stringify(origNs);
            if (nsChanged) {
                this.pendingChanges = { ...this.pendingChanges, nameservers: cleaned };
                // PoLSP: auto-switch to dhcp_static_dns if nameservers added while in DHCP
                if ((this.machine.network_mode || 'dhcp') === 'dhcp' && cleaned.length > 0) {
                    this.pendingChanges = { ...this.pendingChanges, network_mode: 'dhcp_static_dns' };
                    this.machine.network_mode = 'dhcp_static_dns';
                }
            } else {
                const copy = { ...this.pendingChanges };
                delete copy.nameservers;
                this.pendingChanges = copy;
            }
        },

        // Close nameservers editing (called on click-outside via cancelFieldEdit)
        commitNameservers() {
            this.syncNameservers();
            this.cancelFieldEdit();
        },

        // Save all accumulated changes to Dragonfly DB
        saveAllChanges() {
            if (!this.hasPendingChanges()) return;
            this.isSubmitting = true;
            this.editFormError = '';

            // Validate hostname if present
            if (this.pendingChanges.hostname !== undefined && this.pendingChanges.hostname &&
                !/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(this.pendingChanges.hostname)) {
                this.editFormError = 'Invalid hostname format (RFC-1123).';
                this.isSubmitting = false;
                return;
            }

            const payload = { ...this.pendingChanges };

            fetch(`/api/machines/${this.machine.id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        try { throw new Error(JSON.parse(text).message || text); }
                        catch(e) { throw new Error(text || 'Failed to save'); }
                    });
                }
                return response.json();
            })
            .then(data => {
                // Use server response as canonical state
                if (data && data.id) {
                    this.machine = data;
                } else {
                    // Fallback: mark pending_apply if network-affecting fields changed
                    const networkFields = ['network_mode', 'static_ipv4', 'static_ipv6', 'nameservers', 'hostname', 'domain'];
                    if (networkFields.some(f => this.pendingChanges.hasOwnProperty(f))) {
                        this.machine.pending_apply = true;
                    }
                }
                this.pendingChanges = {};
                this._originalMachine = JSON.parse(JSON.stringify(this.machine));
                if (window.showToast) window.showToast('Saved to Dragonfly', 'success');
            })
            .catch(error => {
                this.editFormError = error.message;
                if (window.showToast) window.showToast(error.message, 'error');
            })
            .finally(() => {
                this.isSubmitting = false;
            });
        },

        // Discard all local changes, revert to server state
        cancelAllChanges() {
            this.pendingChanges = {};
            this.editingField = null;
            this.editFormError = '';
            // Re-fetch canonical state from server
            fetch(`/api/machines/${this.machine.id}`)
                .then(r => r.json())
                .then(data => {
                    if (data.machine) {
                        this.machine = data.machine;
                        this._originalMachine = JSON.parse(JSON.stringify(data.machine));
                    }
                })
                .catch(e => console.error('Cancel re-fetch failed:', e));
        },

        // Fetch networks list
        fetchNetworks() {
            fetch('/api/networks')
                .then(r => r.ok ? r.json() : Promise.resolve([]))
                .then(data => { this.networks = Array.isArray(data) ? data : (data.networks || []); })
                .catch(e => console.warn('Could not load networks:', e));
        },

        // Fetch templates list (for OS dropdown)
        fetchTemplates() {
            fetch('/api/templates')
                .then(r => r.ok ? r.json() : Promise.resolve([]))
                .then(data => { this.templates = Array.isArray(data) ? data : []; })
                .catch(e => console.warn('Could not load templates:', e));
        },

        // Create a new network
        createNetwork() {
            if (!this.newNetwork.name.trim()) return;
            fetch('/api/networks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(this.newNetwork)
            })
            .then(r => {
                if (!r.ok) throw new Error('Failed to create network');
                return r.json();
            })
            .then(net => {
                this.networks.push(net);
                this.createNetworkInline = false;
                this.newNetwork = { name: '', vlan_id: '' };
                // Auto-select the new network for this machine
                if (net.id) {
                    this.machine.network_id = net.id;
                    this._setPending('network_id', net.id);
                }
                if (window.showToast) window.showToast('Network created', 'success');
            })
            .catch(error => {
                if (window.showToast) window.showToast(error.message, 'error');
            });
        },

        applyConfig() {
            const applyPromises = [
                fetch(`/api/machines/${this.machine.id}/apply`, { method: 'POST' })
                    .then(response => {
                        if (!response.ok) throw new Error('Apply failed');
                        return response.json();
                    })
            ];

            // For Proxmox VMs, also push cores/RAM config if they have pending changes
            if (this.machine.proxmox_vmid && this.machine.proxmox_node) {
                applyPromises.push(
                    fetch(`/api/machines/${this.machine.id}/proxmox/apply-config`, { method: 'POST' })
                        .then(r => {
                            if (!r.ok) return r.json().then(d => { throw new Error(d.message || d.error || 'Proxmox config push failed'); });
                            return r.json();
                        })
                );
            }

            Promise.all(applyPromises)
                .then(() => {
                    this.machine.pending_apply = false;
                    if (window.showToast) {
                        window.showToast('Configuration applied', 'success');
                    }
                })
                .catch(error => {
                    if (window.showToast) {
                        window.showToast('Apply failed: ' + error.message, 'error');
                    }
                });
        },

        async powerAction(action) {
            if (this.actionInProgress) return;
            this.actionInProgress = action;
            try {
                const res = await fetch(`/api/machines/${this.machine.id}/bmc/power-action`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action })
                });
                const data = await res.json();
                if (res.ok) {
                    window.showToast?.(data.message || `${action} successful`, 'success');
                } else {
                    window.showToast?.(data.message || data.error || `${action} failed`, 'error');
                }
            } catch (e) {
                window.showToast?.(`${action} failed: ${e.message}`, 'error');
            } finally {
                this.actionInProgress = null;
            }
        },

        reimageAction() {
            const os = this.machine.os_choice || this.machine.os_installed;
            if (!os) {
                window.showToast?.('No OS selected. Set an Operating System first.', 'error');
                return;
            }
            this.reimageConfirmModal = true;
        },

        async doReimage() {
            this.reimageConfirmModal = false;
            this.actionInProgress = 'reimage';
            try {
                const res = await fetch(`/api/machines/${this.machine.id}/reimage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();
                if (res.ok) {
                    window.showToast?.('Reimage initiated ‚Äî machine will PXE boot and reinstall', 'success');
                } else {
                    window.showToast?.(data.message || 'Reimage failed', 'error');
                }
            } catch (e) {
                window.showToast?.(`Reimage failed: ${e.message}`, 'error');
            } finally {
                this.actionInProgress = null;
            }
        },

        initSSE() {
            console.log("Initializing SSE connection...");
            if (this.evtSource && this.evtSource.readyState !== EventSource.CLOSED) {
                 console.log("SSE connection already open.");
                 return;
            }
            if (!this.machineId || this.machineId === 'error') {
                 console.warn("Cannot initialize SSE without a valid machine ID.");
                 return;
            }

            if (this.evtSource) {
                this.evtSource.close();
            }

            console.log(`Attempting SSE connection to /api/events for machine ${this.machineId}`);
            this.evtSource = new EventSource('/api/events');
            window.globalEvtSource = this.evtSource;

            this.evtSource.onopen = () => {
                console.log("SSE connection opened.");
                this.error = null;
            };

            this.evtSource.onerror = (err) => {
                console.error('Global SSE connection error:', err);
                console.log('SSE connection error. Browser will attempt to reconnect automatically.');
                this.error = "Connection lost. Attempting to reconnect...";
            };

            this.evtSource.onmessage = (event) => {
                 console.log("Generic SSE message received:", event.data);
            };

            this.evtSource.addEventListener('machine_updated', (event) => {
                console.log('Received machine_updated event:', event.data);
                try {
                    const eventData = JSON.parse(event.data);
                    clearTimeout(this.fetchDebounceTimer);

                    if (eventData.machine) {
                        console.log('Processing full data from SSE event.');
                        if (eventData.machine.id === this.machine.id) {
                            this.machine = eventData.machine;
                            this.workflow_info = eventData.workflow_info || null;
                            console.log('Updated machine state from SSE event:', this.machine);
                            console.log('Updated workflow info from SSE event:', this.workflow_info);
                        } else {
                            console.warn('Received full machine_updated event for a different machine ID:', eventData.machine.id, 'Expected:', this.machine.id);
                        }
                    } else if (eventData.id === this.machine.id) {
                        console.log(`Debouncing fetch for machine ${eventData.id}...`);
                        this.fetchDebounceTimer = setTimeout(() => {
                            console.log(`Executing debounced fetch for machine ${eventData.id}`);
                            fetch(`/api/machines/${eventData.id}`)
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error(`Network response was not ok: ${response.statusText} (${response.status})`);
                                    }
                                    return response.json();
                                })
                                .then(fullData => {
                                    console.log('Fetched full data after event:', fullData);
                                    if (fullData.machine && fullData.machine.id === this.machine.id) {
                                        this.machine = fullData.machine;
                                        this.workflow_info = fullData.workflow_info || null;
                                        console.log('Updated machine state via fetch:', this.machine);
                                        console.log('Updated workflow info via fetch:', this.workflow_info);
                                        this.error = null;
                                    } else if (fullData.machine && fullData.machine.id !== this.machine.id) {
                                        console.warn('Fetched data belongs to a different machine ID:', fullData.machine.id, 'Expected:', this.machine.id);
                                    } else {
                                        console.warn('Fetched data missing machine structure or ID mismatch:', fullData);
                                    }
                                })
                                .catch(error => {
                                    console.error('Error fetching full machine data:', error);
                                    this.error = `Failed to fetch update for ${eventData.id}: ${error.message}. Retrying on next event.`;
                                });
                        }, 32);
                    } else {
                        console.warn('Ignoring machine_updated event: ID mismatch or invalid format.', 'Event ID:', eventData.id, 'Current Machine ID:', this.machine.id);
                    }
                } catch (e) {
                    console.error('Error parsing machine_updated event data:', e, 'Raw data:', event.data);
                    this.error = "Error processing update event.";
                }
            });

            this.evtSource.addEventListener('machine_discovered', (event) => {
                console.log("SSE Listener: machine_discovered received:", event.data);
            });

            this.evtSource.addEventListener('ip_download_progress', (event) => {
                console.log("[PROGRESS_LISTENER] Listener is active!");
                console.log("SSE Listener: ip_download_progress received:", event.data);
                try {
                    const progressData = JSON.parse(event.data);
                    if (progressData.machine_id === this.machineId) {
                         console.log("Matching machine ID for progress update.");
                         const taskName = progressData.file_name || 'stream image';
                         const bytesDownloaded = progressData.bytes_downloaded;
                         const totalSize = progressData.total_size;
                         const calculatedProgress = (totalSize > 0) ? (bytesDownloaded / totalSize * 100) : 0;

                         if (this.taskProgressState[taskName] !== undefined) {
                            this.taskProgressState[taskName] = {
                                percent: calculatedProgress,
                                bytesDownloaded: bytesDownloaded,
                                totalSize: totalSize
                            };
                            console.log(`Updated taskProgressState for ${taskName}:`, JSON.stringify(this.taskProgressState[taskName]));
                         } else {
                            console.warn(`Task state key not found for progress update: ${taskName}`);
                         }
                     }
                } catch (e) {
                     console.error('Error processing ip_download_progress event:', e, event.data);
                }
            });

             this.evtSource.addEventListener('task_progress', (event) => {
                 console.log("SSE Listener: task_progress received:", event.data);
             });

            this.evtSource.addEventListener('workflow_progress', (event) => {
                try {
                    const d = JSON.parse(event.data);
                    if (d.machine_id === this.machineId) {
                        this.liveProgress = {
                            percent: d.percent || 0,
                            action: d.action || '',
                            message: d.message || '',
                            bytesTransferred: d.bytes_transferred || 0,
                            bytesTotal: d.bytes_total || 0,
                        };
                        // Also update workflow_info.progress for the big progress section
                        if (this.workflow_info) {
                            this.workflow_info.progress = d.percent || 0;
                            if (d.action) this.workflow_info.current_action = d.action;
                        }
                    }
                } catch (e) {
                    console.error('Error processing workflow_progress:', e);
                }
            });

        },

        initializeComponent() {
            console.log("Initializing Machine Details Component");

            const machineDataElement = document.getElementById('machine-data-json');
            const workflowDataElement = document.getElementById('workflow-data-json');

            if (machineDataElement && machineDataElement.textContent) {
                try {
                    this.machine = JSON.parse(machineDataElement.textContent);
                    console.log("Machine data loaded from JSON:", this.machine);

                    this.machineId = this.machine.id;
                    this.machineIp = this.machine.ip_address;
                    this._originalMachine = JSON.parse(JSON.stringify(this.machine));
                    this._originalMemorableName = this.machine.memorable_name || '';
                    console.log("Machine ID set to:", this.machineId);

                    this.ipAddressType = '{{ ip_address_type | safe }}';
                } catch (e) {
                    console.error("Failed to parse machine JSON:", e);
                    this.machine = { id: 'error', ip_address: 'error', status: 'Error parsing data', hostname: 'Error' };
                    this.workflow_info = null;
                    this.machineId = 'error';
                    this.machineIp = 'error';
                }
            } else {
                console.error("Machine data not found in script tag.");
                this.machine = { id: 'error', ip_address: 'error', status: 'Error parsing data', hostname: 'Error' };
                this.workflow_info = null;
                this.machineId = 'error';
                this.machineIp = 'error';
            }

            if (workflowDataElement && workflowDataElement.textContent) {
                try {
                    this.workflow_info = JSON.parse(workflowDataElement.textContent);
                    console.log("Workflow info loaded from JSON:", this.workflow_info);
                } catch (e) {
                    console.error("Failed to parse workflow JSON:", e);
                    this.workflow_info = null;
                }
            }

            // Seed liveProgress from persisted installation_progress
            if (this.machine.installation_progress > 0) {
                this.liveProgress.percent = this.machine.installation_progress;
                this.liveProgress.message = this.machine.installation_step || '';
            }
            if (this.workflow_info) {
                this.liveProgress.percent = this.workflow_info.progress || this.liveProgress.percent;
                this.liveProgress.action = this.workflow_info.current_action || '';
            }

            this.$nextTick(() => {
                if (this.workflow_info && this.workflow_info.tasks) {
                    this.workflow_info.tasks.forEach(task => {
                        if (this.taskProgressState[task.name] === undefined) {
                            this.taskProgressState[task.name] = {
                                percent: task.progress || 0,
                                bytesDownloaded: 0,
                                totalSize: 0
                            };
                        }
                    });
                    console.log("Initial taskProgressState:", JSON.stringify(this.taskProgressState));
                }

                // Initialize Lucide icons after Alpine renders
                if (window.lucide) {
                    lucide.createIcons();
                }
            });

            // Load OS display names
            fetch('/static/os_names.json')
                .then(r => r.json())
                .then(names => { this.osNames = names; })
                .catch(e => console.warn('Could not load OS names:', e));

            this.fetchNetworks();
            this.fetchTemplates();
            this.initSSE();
        },

        generateProgressText(progressInfo) {
            if (!progressInfo) {
                return '0%';
            }
            const percent = progressInfo.percent || 0;
            if (progressInfo.totalSize > 0) {
                const downloadedMB = (progressInfo.bytesDownloaded / (1024 * 1024)).toFixed(1);
                const totalMB = (progressInfo.totalSize / (1024 * 1024)).toFixed(1);
                return `${percent.toFixed(1)}% (${downloadedMB}/${totalMB} MB)`;
            } else {
                return `${percent.toFixed(1)}%`;
            }
        },

        fetchMachineData() {
            if (!this.machineId) return;
            this.evtSource.addEventListener('ip_download_progress', (event) => {
                console.log("[PROGRESS_LISTENER] Listener is active!");
                console.log("SSE Listener: ip_download_progress received:", event.data);
                try {
                    const progressData = JSON.parse(event.data);
                    if (progressData.machine_id === this.machineId) {
                         console.log("Matching machine ID for progress update.");
                         const taskName = progressData.file_name || 'stream image';
                         const bytesDownloaded = progressData.bytes_downloaded;
                         const totalSize = progressData.total_size;
                         const calculatedProgress = (totalSize > 0) ? (bytesDownloaded / totalSize * 100) : 0;

                         if (this.taskProgressState[taskName] !== undefined) {
                            this.taskProgressState[taskName] = {
                                percent: calculatedProgress,
                                bytesDownloaded: bytesDownloaded,
                                totalSize: totalSize
                            };
                            console.log(`Updated taskProgressState for ${taskName}:`, JSON.stringify(this.taskProgressState[taskName]));
                         } else {
                            console.warn(`Task state key not found for progress update: ${taskName}`);
                         }
                     }
                } catch (e) {
                     console.error('Error processing ip_download_progress event:', e, event.data);
                }
            });

             this.evtSource.addEventListener('task_progress', (event) => {
                 console.log("SSE Listener: task_progress received:", event.data);
             });

        }
    };
  }

  document.addEventListener('DOMContentLoaded', () => {
    console.log("Machine details page loaded, Alpine component should initialize shortly.");
  });
</script>
{% endblock %}
